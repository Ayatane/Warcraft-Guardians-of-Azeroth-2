##########################
# Purge of Heresy tenets #
# by ElMariuso (chad)    #
##########################

give_scarlet_mark_interaction = {
	category = interaction_category_hostile
	common_interaction = yes #suppress error
	icon = give_scarlet_mark
	
	desc = give_scarlet_mark_interaction_desc

	is_shown = {
		scope:actor = {
			trigger_if = {
				limit = { exists = faith.religious_head }
				this = faith.religious_head
			}
			trigger_else = {
				liege ?= { is_independent_ruler = yes }
				NOT = { this = liege }
				is_in_same_realm_as_target = { CHARACTER = scope:recipient } 
				has_council_position = councillor_court_chaplain
			}
		}
		scope:actor.faith = {
			this = scope:recipient.faith
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}

		NOT = {
			scope:recipient = {
				has_trait = scarlet_mark
			}
		}

		NOT = { #Don't do this to yourself
			scope:recipient = scope:actor 
		}
	}

	is_valid_showing_failures_only = {
		scope:recipient = {
			age >= age_12_value
		}
		scope:actor = {
			piety >= medium_piety_value
		}
		scope:actor = {
			custom_description = {
				text = "hof_interaction_unreformed_faith"
				NOT = {
					faith = { has_doctrine_parameter = unreformed }
				}
			}
		}
		scope:recipient = { NOT = { has_strong_hook = scope:actor } }
		custom_tooltip = {
			text = cannot_take_overt_hostile_actions_against_diarch.tt
			NOT = { scope:recipient ?= scope:actor.diarch }
		}
	}

	auto_accept = yes
	force_notification = yes
	notification_text = wc_religious_interaction.1021
	
	on_accept = {
		scope:actor = {
			add_piety = minor_piety_loss
			hidden_effect = {
				send_interface_toast = {	
					title = give_scarlet_mark_interaction_desc.tt
					left_icon = scope:recipient
					scope:recipient = {
						show_as_tooltip = { add_trait = scarlet_mark }
					}
				}
			}
		}
		scarlet_mark_character = {
			REQUESTING_CHARACTER = scope:actor
			TARGET_CHARACTER = scope:recipient
		}

		scope:recipient = {
			hidden_effect = { #Nudge towards rivalry
				if = {
					limit = {
						NOR = {
							has_relation_rival = scope:actor
							has_relation_potential_rival = scope:actor
						}
					}
					set_relation_potential_rival = scope:actor
				}
			}
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		piety >= medium_piety_value
	}
	
	ai_target_quick_trigger = {
		adult = yes
	}

	ai_targets = {
		ai_recipients = scripted_relations
		ai_recipients = primary_war_enemies
	}
	
	ai_frequency = 4

	ai_will_do = {
		base = 50

		ai_value_modifier = {
			who = scope:actor
			ai_vengefulness = 0.5
		}
		
		modifier = {
			add = {
				add = 10
				multiply = scope:recipient.num_sinful_traits
			}
			scope:recipient.num_sinful_traits > 0
			desc = EXCOMMUNICATION_SINS
		}
	}
}

lift_scarlet_mark_interaction = {
	category = interaction_category_religion
	icon = give_scarlet_mark

	common_interaction = yes

	desc = lift_scarlet_mark_interaction_desc

	is_shown = {
		scope:actor = {
			trigger_if = {
				limit = { exists = faith.religious_head }
				this = faith.religious_head
			}
			trigger_else = {
				liege ?= { is_independent_ruler = yes }
				scope:recipient.liege = liege
				NOT = { this = liege }
				has_council_position = councillor_court_chaplain
			}
		}
		scope:actor.faith = {
			this = scope:recipient.faith
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}
		scope:recipient = {
			has_trait = scarlet_mark
		}
	}

	is_valid_showing_failures_only = {
		scope:recipient = { is_busy_in_events_localised = yes }
		scope:actor = {
			NOT = {
				is_at_war_with = scope:recipient
			}
		}
	}

	auto_accept = yes
	force_notification = yes
	notification_text = wc_religious_interaction.1024
	#answer_accept_key = religious_interaction.1024.positive

	on_accept = {
		lift_character_scarlet_mark_effect = {
			TARGET_CHARACTER = scope:recipient
			REQUESTING_CHARACTER = scope:actor
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		piety >= major_piety_value
	}
	
	ai_target_quick_trigger = {
		adult = yes
	}

	ai_targets = {
		ai_recipients = scripted_relations
		ai_recipients = war_allies
	}
	
	ai_frequency = 72

	ai_will_do = {
		base = 10

		ai_value_modifier = { # +50 to -50
			who = scope:actor
			ai_compassion = 0.5
		}
		
		modifier = {
			factor = 0
			scope:recipient = {
				NOR = {
					has_relation_friend = scope:actor
					has_relation_best_friend = scope:actor
					is_allied_to = scope:actor
				}
			}
		}
	}
}

request_scarlet_mark_interaction = {
	category = interaction_category_hostile
	icon = scarlet_mark

	desc = request_scarlet_mark_interaction_desc
	redirect = {
		if = {
			limit = {
				exists = scope:actor.faith.religious_head
			}
			scope:recipient = {
				save_scope_as = secondary_recipient
			}
			scope:actor.faith.religious_head = {
				save_scope_as = recipient
			}
		}
		else_if = {
			limit = {
				NOT = {
					exists = scope:actor.faith.religious_head
				}
				exists = scope:actor.cp:councillor_court_chaplain
			}
			scope:recipient = {
				save_scope_as = secondary_recipient
			}
			scope:actor.cp:councillor_court_chaplain = {
				save_scope_as = recipient
			}
		}
	}

	notification_text = RELIGIOUS_HEAD_REQUEST_SCARLET_MARK

	is_shown = {
		scope:actor = {
			trigger_if = {
				limit = { exists = faith.religious_head }
			}
			trigger_else = {
				liege ?= { is_independent_ruler = yes }
				exists = cp:councillor_court_chaplain
			}
			is_in_same_realm_as_target = { CHARACTER = scope:secondary_recipient } 
		}
		scope:actor.faith = {
			this = scope:recipient.faith
			has_doctrine = tenet_purge_of_heresy
			has_doctrine = doctrine_spiritual_head
		}
		NOT = { 
			scope:secondary_recipient = { 
				has_trait = scarlet_mark
			}
		}
	}

	is_valid_showing_failures_only = {
		scope:actor = {
			piety >= massive_piety_value
		}
		scope:secondary_recipient = { #Scarlet Mark target
			age >= age_12_value
		}
		scope:actor = {
			custom_description = {
				text = "hof_interaction_unreformed_faith"
				NOT = {
					faith = { has_doctrine_parameter = unreformed }
				}
			}
			NOT = {
				is_at_war_with = scope:recipient
			}
		}
		scope:recipient = { is_busy_in_events_localised = yes }
		scope:secondary_recipient = { NOT = { has_strong_hook = scope:actor } }
		custom_tooltip = {
			text = cannot_take_overt_hostile_actions_against_diarch.tt
			NOT = { scope:recipient ?= scope:actor.diarch }
		}
	}

	send_option = {
		is_valid = {
			scope:actor = {
				has_usable_hook = scope:recipient
			}
		}
		flag = excommunication_hook
		localization = EXCOMMUNICATION_HOOK
	}
	should_use_extra_icon = {
		scope:actor = { has_usable_hook = scope:recipient }
	}
	extra_icon = "gfx/interface/icons/character_interactions/hook_icon.dds"

	send_options_exclusive = no

	auto_accept = {
		custom_description = {
			text = "spending_hook"
			subject = scope:actor
			object = scope:recipient
			scope:excommunication_hook = yes
			scope:actor = { has_strong_hook = scope:recipient }
		}
	}

	ai_accept = {
		base = -50
			
		modifier = {
			scope:excommunication_hook = yes
			add = 50
			desc = SCHEME_WEAK_HOOK_USED
		}
		opinion_modifier = {
			who = scope:actor.faith.religious_head
			opinion_target = scope:actor
			multiplier = 1
		}
		opinion_modifier = {
			who = scope:actor.faith.religious_head
			opinion_target = scope:secondary_recipient #Excommunication target
			multiplier = -1
			min = 0
		}
		modifier = {
			add = -100
			scope:actor.faith.religious_head = {
				opinion = {
					value > 0
					target = scope:secondary_recipient #Excommunication target
				}
			}
			desc = EXCOMMUNICATION_OPINION
		}
		modifier = {
			add = {
				add = -10
				multiply = scope:secondary_recipient.num_virtuous_traits
			}
			scope:secondary_recipient.num_virtuous_traits > 0
			desc = EXCOMMUNICATION_VIRTUES
		}
		modifier = {
			add = {
				add = 10
				multiply = scope:secondary_recipient.num_sinful_traits
			}
			scope:secondary_recipient.num_sinful_traits > 0
			desc = EXCOMMUNICATION_SINS
		}
		modifier = {
			desc = RELIGIOUS_HEAD_INTERACTION_PARAGON
			add = 15
			scope:actor = {
				has_trait = paragon
			}
		}
		modifier = {
			desc = RELIGIOUS_HEAD_INTERACTION_CONSECRATED_BLOOD
			add = 5
			scope:actor = {
				has_trait = consecrated_blood
			}
		}
		
		# Warcraft
		scourge_interaction_modifiers = yes
	}
	
	ai_min_reply_days = 1
	ai_max_reply_days = 5

	on_accept = {
		if = {
			limit = {
				scope:secondary_recipient = { is_alive = yes }
			}
			if = {
				limit = { scope:excommunication_hook = yes }
				scope:actor = {
					use_hook = scope:recipient
				}
			}

			scope:actor = {
				#Spend piety for the excommunication.
				add_piety = massive_piety_loss

				#Letter event to inform character the pope agreed to their request.
				trigger_event = {
					id = religious_interaction.1022
				}
			}
			scarlet_mark_character = {
				TARGET_CHARACTER = scope:secondary_recipient
				REQUESTING_CHARACTER = scope:actor
			}
			scope:secondary_recipient = {
				#Letter event to inform character that they have been excommunicated.
				trigger_event = {
					id = religious_interaction.1020
				}
				hidden_effect = { #Nudge towards rivalry
					if = {
						limit = {
							NOR = {
								has_relation_rival = scope:actor
								has_relation_potential_rival = scope:actor
							}
							scope:actor = { is_alive = yes }
						}
						set_relation_potential_rival = scope:actor
					}
				}
			}
		}
	}

	on_decline = {
		scope:actor = {
			#Letter event to inform character the pope refused their request.
			trigger_event = {
				id = religious_interaction.1023
			}
		}
	}
	
	# AI will do
	
	ai_potential = {
		is_adult = yes
		piety >= major_piety_value
	}
	
	ai_target_quick_trigger = {
		adult = yes
	}

	ai_targets = {
		ai_recipients = scripted_relations
		ai_recipients = primary_war_enemies
	}
	
	ai_frequency = 36

	ai_will_do = {
		base = 25

		ai_value_modifier = { # +50 to -50
			who = scope:actor
			ai_vengefulness = 0.5
		}
		
		modifier = {
			factor = 0
			scope:secondary_recipient = {
				NOR = {
					has_relation_rival = scope:actor
					has_relation_nemesis = scope:actor
					is_at_war_with = scope:actor
				}
			}
		}
	}
}