init_elemental_fire_spells_effect = {
	add_to_global_variable_list = { name = elemental_fire_spells target = flag:summon_fire_elemental }
	add_to_global_variable_list = { name = elemental_fire_spells target = flag:lava_lash }
}

cast_summon_fire_elemental_effect = {
	if = {
		limit = { exists = var:summon_fire_elemental_recipient }
		var:summon_fire_elemental_recipient = {
			save_temporary_scope_as = first_recipient
		}
	}
	else_if = {
		limit = { exists = var:spell_recipient }
		var:spell_recipient = {
			save_temporary_scope_as = first_recipient
		}
	}

	if = {
		limit = {
			exists = scope:first_recipient.holder
		}
		scope:first_recipient.holder = {
			save_scope_as = this_recipient
		}
		if = {
			limit = {
				exists = scope:first_recipient.holder.liege
			}
			scope:first_recipient.holder.liege = {
				save_scope_as = this_recipient
			}
		}
		if = {
			limit = {
				exists = scope:first_recipient.holder.top_liege
			}
			scope:first_recipient.holder.top_liege = {
				save_scope_as = this_recipient
			}
		}
	}
	else = {
		scope:first_recipient = {
			save_scope_as = this_recipient
		}
	}

	if = {
		limit = { 
			exists = scope:this_recipient
			OR = { # current_spell_rank is for tooltips
				AND = {
					exists = var:summon_fire_elemental_rank
					var:summon_fire_elemental_rank >= 1
				}
				AND = {
					exists = var:current_spell_rank
					var:current_spell_rank >= 1	
				}
			}
		}

		scope:this_recipient = {
			add_character_modifier = {
				modifier = wc_summon_fire_elemental_modifier
				days = wc_spell_summon_fire_elemental_duration_days_value
			}
		}

		if = {
			limit = { 
				OR = {
					AND = {
						exists = var:summon_fire_elemental_rank
						var:summon_fire_elemental_rank >= 2
					}
					AND = {
						exists = var:current_spell_rank
						var:current_spell_rank >= 2
					}
				}
			}
			scope:this_recipient = {
				add_character_flag = {
					flag = has_fire_elemental_maa
					days =  
				}
				liege ?= {
					add_character_flag = {
						flag = has_fire_elemental_maa
						days = 735 
					}
				}
				
				if = {
					limit = { # actual effect
						exists = root.var:spell_recipient
						NOT = {
							exists = root.var:summon_fire_elemental_recipient
						}
					}
					spawn_army = {
						uses_supply = no
						inheritable = yes
						war = war
						name = summoned_fire_elemental
						men_at_arms = {
							type = fire_elemental
							stacks = 1
						}
						location = root.var:spell_recipient.title_province
					}
				}
				else_if = {
					limit = { # actual effect
						exists = root.var:summon_fire_elemental_recipient
					}
					spawn_army = {
						uses_supply = no
						inheritable = yes
						war = war
						name = summoned_fire_elemental
						men_at_arms = {
							type = fire_elemental
							stacks = 1
						}
						location = root.var:summon_fire_elemental_recipient.title_province
					}
				}
			}
			if = {
				limit = {
					OR = {
						AND = {
							exists = var:summon_fire_elemental_rank
							var:summon_fire_elemental_rank = 3
						}
						AND = {
							exists = var:current_spell_rank
							var:current_spell_rank = 3
						}
					}
				}
				scope:this_recipient = {
					add_character_modifier = {
						modifier = wc_empowered_fire_elemental_modifier
						days = wc_spell_summon_fire_elemental_duration_days_value
					}
				}
			}
		}
	}

	remove_variable = summon_fire_elemental_recipient
	remove_variable = summon_fire_elemental_rank
}

cast_lava_lash_effect = {
	if = {
		limit = { exists = var:lava_lash_recipient }
		var:lava_lash_recipient = {
			save_temporary_scope_as = this_recipient
		}
	}
	else_if = {
		limit = { exists = var:spell_recipient }
		var:spell_recipient = {
			save_temporary_scope_as = this_recipient
		}
	}

	if = {
		limit = {
			exists = scope:this_recipient
		}
		scope:this_recipient.title_province = {
			add_province_modifier = {
				modifier = wc_lava_lash_modifier
				days = wc_spell_lava_lash_duration_days_value
			}
		}
	}
}