init_elemental_fire_spells_effect = {
	add_to_global_variable_list = { name = elemental_fire_spells target = flag:summon_fire_elemental }
	add_to_global_variable_list = { name = elemental_fire_spells target = flag:lava_lash }
	add_to_global_variable_list = { name = elemental_fire_spells target = flag:backdraft }
}

cast_summon_fire_elemental_effect = {
	if = {
		limit = { exists = var:summon_fire_elemental_recipient }
		var:summon_fire_elemental_recipient = {
			save_temporary_scope_as = first_recipient
		}
	}
	else_if = {
		limit = { exists = var:spell_recipient }
		var:spell_recipient = {
			save_temporary_scope_as = first_recipient
		}
	}

	if = {
		limit = {
			exists = scope:first_recipient.holder
		}
		scope:first_recipient.holder = {
			save_scope_as = this_recipient
		}
		if = {
			limit = {
				exists = scope:first_recipient.holder.liege
			}
			scope:first_recipient.holder.liege = {
				save_scope_as = this_recipient
			}
		}
		if = {
			limit = {
				exists = scope:first_recipient.holder.top_liege
			}
			scope:first_recipient.holder.top_liege = {
				save_scope_as = this_recipient
			}
		}
	}
	else = {
		scope:first_recipient = {
			save_scope_as = this_recipient
		}
	}

	if = {
		limit = { 
			exists = scope:this_recipient
			OR = { # current_spell_rank is for tooltips
				AND = {
					exists = var:summon_fire_elemental_rank
					var:summon_fire_elemental_rank >= 1
				}
				AND = {
					exists = var:current_spell_rank
					var:current_spell_rank >= 1	
				}
			}
		}

		scope:this_recipient = {
			add_character_modifier = {
				modifier = wc_summon_fire_elemental_modifier
				days = wc_spell_summon_fire_elemental_duration_days_value
			}
		}

		if = {
			limit = { 
				OR = {
					AND = {
						exists = var:summon_fire_elemental_rank
						var:summon_fire_elemental_rank >= 2
					}
					AND = {
						exists = var:current_spell_rank
						var:current_spell_rank >= 2
					}
				}
			}
			scope:this_recipient = {
				add_character_flag = {
					flag = has_fire_elemental_maa
					days =  
				}
				liege ?= {
					add_character_flag = {
						flag = has_fire_elemental_maa
						days = 735 
					}
				}
				
				if = {
					limit = { # actual effect
						exists = root.var:spell_recipient
						NOT = {
							exists = root.var:summon_fire_elemental_recipient
						}
					}
					spawn_army = {
						uses_supply = no
						inheritable = yes
						war = war
						name = summoned_fire_elemental
						men_at_arms = {
							type = fire_elemental
							stacks = 1
						}
						location = root.var:spell_recipient.title_province
					}
				}
				else_if = {
					limit = { # actual effect
						exists = root.var:summon_fire_elemental_recipient
					}
					spawn_army = {
						uses_supply = no
						inheritable = yes
						war = war
						name = summoned_fire_elemental
						men_at_arms = {
							type = fire_elemental
							stacks = 1
						}
						location = root.var:summon_fire_elemental_recipient.title_province
					}
				}
			}
			if = {
				limit = {
					OR = {
						AND = {
							exists = var:summon_fire_elemental_rank
							var:summon_fire_elemental_rank = 3
						}
						AND = {
							exists = var:current_spell_rank
							var:current_spell_rank = 3
						}
					}
				}
				scope:this_recipient = {
					add_character_modifier = {
						modifier = wc_empowered_fire_elemental_modifier
						days = wc_spell_summon_fire_elemental_duration_days_value
					}
				}
			}
		}
	}
}

cast_lava_lash_effect = {
	if = {
		limit = { exists = var:lava_lash_recipient }
		var:lava_lash_recipient = {
			save_temporary_scope_as = this_recipient
		}
	}
	else_if = {
		limit = { exists = var:spell_recipient }
		var:spell_recipient = {
			save_temporary_scope_as = this_recipient
		}
	}

	if = {
		limit = {
			exists = scope:this_recipient
		}
		scope:this_recipient.title_province = {
			add_province_modifier = {
				modifier = wc_lava_lash_modifier
				days = wc_spell_lava_lash_duration_days_value
			}
			if = { # counting stacks
				limit = {
					has_variable = lava_lash
				}
				set_variable = {
					name = lava_lash_2
					value = yes
					days = wc_spell_lava_lash_duration_days_value
				}
			}
			else_if = {
				limit = {
					has_variable = lava_lash_2
				}
				set_variable = {
					name = lava_lash_3
					value = yes
					days = wc_spell_lava_lash_duration_days_value
				}
			}
			else = {
				set_variable = {
					name = lava_lash
					value = yes
					days = wc_spell_lava_lash_duration_days_value
				}
			}
		}
		hidden_effect = {
			if = {
				limit = { # empowered perk
					has_perk = elemental_fire_magic_tree_2_perk_7
				}
				90 = {
					# nothing
				}
				10 = {
					scope:this_recipient.title_province = {
						random_neighboring_province = {
							limit = {
								holder = prev.holder
							}
							add_province_modifier = {
								modifier = wc_lava_lash_modifier
								days = wc_spell_lava_lash_duration_days_value
							}
						}
					}
				}
			}
		}
	}
}

cast_backdraft_effect = {
	if = {
		limit = { exists = var:backdraft_recipient }
		var:backdraft_recipient = {
			save_scope_as = this_recipient
		}
	}
	else_if = {
		limit = { exists = var:spell_recipient }
		var:spell_recipient = {
			save_scope_as = this_recipient
		}
	}
	save_scope_as = caster
	if = {
		limit = {
			exists = scope:this_recipient
		}
		scope:this_recipient.title_province = {
			custom_tooltip = wc_backdraft_tt
			set_variable = {
				name = backdraft_monitor
				value = scope:caster
			}
		}	
	}
	if = { #tooltip
		limit = {
			has_variable_list = spell_targets_list
			var:current_spell_rank = 2
		}
		every_in_list = {
			variable = spell_targets_list
			title_province = { save_scope_as = this_recipient }
			scope:this_recipient = {
				custom_tooltip = wc_backdraft_tt
				set_variable = {
					name = backdraft_monitor
					value = scope:caster
				}
			}
		}
	}
	else_if = { #tooltip
		limit = {
			has_variable_list = spell_targets_list
			var:current_spell_rank = 3
		}
		every_in_list = {
			variable = spell_targets_list
			save_scope_as = this_recipient
			scope:this_recipient = {
				custom_tooltip = wc_backdraft_tt
				set_variable = {
					name = backdraft_monitor
					value = scope:caster
				}
			}
		}
	}
	if = { #real
		limit = {
			has_variable_list = backdraft_targets_list
			var:backdraft_spell_rank = 2
		}
		every_in_list = {
			variable = backdraft_targets_list
			title_province = { save_scope_as = this_recipient }
			scope:this_recipient = {
				custom_tooltip = wc_backdraft_tt
				set_variable = {
					name = backdraft_monitor
					value = scope:caster
				}
			}
		}
	}
	else_if = { #tooltip
		limit = {
			has_variable_list = backdraft_targets_list
			var:backdraft_spell_rank = 3
		}
		every_in_list = {
			variable = backdraft_targets_list
			save_scope_as = this_recipient
			scope:this_recipient = {
				custom_tooltip = wc_backdraft_tt
				set_variable = {
					name = backdraft_monitor
					value = scope:caster
				}
			}
		}
	}
}

backdraft_proc_effect = {
	send_interface_message = {
		title = backdraft_proc_title
		if = {
			limit = {
				wc_current_mana_percent_value < 0.9
			}
			wc_change_mana_by_value_effect = { # add mana
				CHANGE = add
				VALUE = wc_spell_$SPELL$_cost_mana_value
			}
		}
		else = {
			add_character_modifier = {
				modifier = wc_backdraft_proc
				days = 180
			}
		}
	}
	
	if = { limit = { $RANK$ = 1 }} # error supress
	if = { limit = { flag:$TYPE$ = flag:poop }} # error supress
}

animate_rage_effect = {
	$ARTIFACT$ = {
		save_scope_as = dead_artifact
	}
	# Current Conversions
	# per 20% durability, 1 prowess, dread + 5% hostile scheme sucess chance
	scope:dead_artifact = {
		root = {
			set_variable = {
				name = artifact_dur_percent
				value = prev.artifact_durability_percent_rounded
				days = 5
			}
			change_variable = {
				name = artifact_dur_percent
				multiply = 100
			}
		}
	}
	send_interface_toast = {
		title = animate_rage_complete
		while = {
			count = {
				value = var:artifact_dur_percent
				divide = 20
			}
			add_character_modifier = {
				modifier = wc_animate_rage_modifier
			}
		}
		add_character_flag = {
			flag = animate_rage_cooldown
			days = 3650
		}	
	}
}