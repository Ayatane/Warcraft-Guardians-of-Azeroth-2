init_mining_reagents_effect = {
	add_to_global_variable_list = { name = mining_reagents target = flag:thorium }
	add_to_global_variable_list = { name = mining_reagents target = flag:obsidium }
	add_to_global_variable_list = { name = mining_reagents target = flag:gold }
	add_to_global_variable_list = { name = mining_reagents target = flag:pyrite }
	add_to_global_variable_list = { name = mining_reagents target = flag:elementium }
	add_to_global_variable_list = { name = mining_reagents target = flag:iron }
	add_to_global_variable_list = { name = mining_reagents target = flag:silver }
	add_to_global_variable_list = { name = mining_reagents target = flag:saronite }
	add_to_global_variable_list = { name = mining_reagents target = flag:titansteel }
	add_to_global_variable_list = { name = mining_reagents target = flag:ghost_iron }
	add_to_global_variable_list = { name = mining_reagents target = flag:draconium }
	add_to_global_variable_list = { name = mining_reagents target = flag:leystone }
	add_to_global_variable_list = { name = mining_reagents target = flag:cobalt }
	add_to_global_variable_list = { name = mining_reagents target = flag:khorium }
	add_to_global_variable_list = { name = mining_reagents target = flag:felsteel }
	add_to_global_variable_list = { name = mining_reagents target = flag:earthen }
	add_to_global_variable_list = { name = mining_reagents target = flag:mithril }
	add_to_global_variable_list = { name = mining_reagents target = flag:kyparite }
	add_to_global_variable_list = { name = mining_reagents target = flag:titanium }
	add_to_global_variable_list = { name = mining_reagents target = flag:nethercite }
	add_to_global_variable_list = { name = mining_reagents target = flag:opal }
	add_to_global_variable_list = { name = mining_reagents target = flag:diamond }
	add_to_global_variable_list = { name = mining_reagents target = flag:resonite }
	add_to_global_variable_list = { name = mining_reagents target = flag:night_stone }
	add_to_global_variable_list = { name = mining_reagents target = flag:mojo_stone }
	add_to_global_variable_list = { name = mining_reagents target = flag:mana_stone }
	add_to_global_variable_list = { name = mining_reagents target = flag:ruby }
	add_to_global_variable_list = { name = mining_reagents target = flag:lapis_lazuli }
	add_to_global_variable_list = { name = mining_reagents target = flag:jade }
	add_to_global_variable_list = { name = mining_reagents target = flag:singing_crystal }
	add_to_global_variable_list = { name = mining_reagents target = flag:kajamite }

	set_global_variable = { name = mining_reagents_done value = yes }
}

smelt_reagent_effect = {
	change_variable = {
		name = $REAGENT$_amount_ore
		add = {
			value = var:batch_amount #eg. 10, removes 10 ores
			multiply = -1
		}
	}

	if = {
		limit = {
			NOT = { has_variable = $REAGENT$_amount_bar }
		}
		set_variable = {
			name = $REAGENT$_amount_bar
			value = 0
		}
	}

	change_variable = {
		name = $REAGENT$_amount_bar
		add = {
			value = var:batch_amount #e.g. 10, made 2 bars
			divide = 5	
		}
	}

	if = {
		limit = { # just in case
			NOT = { has_variable = $REAGENT$_amount }
		}
		set_variable = {
			name = $REAGENT$_amount
			value = 0
		}
	}

	set_variable = {
		name = $REAGENT$_amount
		value = {
			add = var:$REAGENT$_amount_bar
			add = var:$REAGENT$_amount_ore
		}
	}
	
	change_variable = {
		name = Mining_items_made
		add = {
			value = var:batch_amount #e.g. 10, made 2 bars
			divide = 5
		}
	}
	
	send_interface_toast = {
		title = smelt_success
	}
	
	#Remove if it's 0, because otherwise its just doing nothing
	if = {
		limit = { 
			var:$REAGENT$_amount_ore ?= 0
		}
		remove_variable = $REAGENT$_amount_ore
	}

	if = {
		limit = { 
			var:$REAGENT$_amount_bar ?= 0
		}
		remove_variable = $REAGENT$_amount_bar
	}
}

# NEED TO BE REDONE
pickup_ore_effect = {
	# determine (up to) how many different reagents will be in this ore 
	random_list = {
		10 = { set_variable = { name = ore_different_reagents value = 4 } }
		40 = { set_variable = { name = ore_different_reagents value = 3 } }
		30 = { set_variable = { name = ore_different_reagents value = 2 } }
		10 = { set_variable = { name = ore_different_reagents value = 1 } }
	}

	if = {
		limit = {
			var:ore_different_reagents > 1
			location = { has_modifier = recently_mined_modifier }
		}
		change_variable = {
			name = ore_different_reagents
			add = -1
		}
	}

	set_variable = {
		name = potential_count
		value = 0 
	}

	clear_variable_list = last_discovered_reagents
	save_scope_as = crafter

	# Make a list to see which reagents are availiable in this region. (this usually never changes if you stay in the same place)
	every_in_global_list = {
		variable = mining_reagents
		save_scope_as = new_reagent
		scope:crafter = {
			if = {
				limit = {
					location = { trigger_for_scoped_reagent = { TRIGGER = province_has_reagent_trigger REAGENT = scope:new_reagent } }
				}
				effect_for_scoped_reagent = {
					REAGENT = scope:new_reagent
					EFFECT = add_to_location_list
				}
			}
			else = {}
		}
	}

	while = {
		count = 4
		random_in_list = {
			variable = reagents_here
			save_scope_as = current_reagent
			scope:crafter = {
				remove_variable = will_discover_current_reagent
				# run the effect to see if we will actually pick up this reagent
				effect_for_scoped_reagent = {
					REAGENT = scope:current_reagent
					EFFECT = chance_of_finding_reagent_effect
				}
				if = {
					limit = {
						OR = {
							# we dont discover whatever reagent (unlikely), but we were only gonna get 1, so give it to them
							var:ore_different_reagents = 1 
							var:will_discover_current_reagent = yes
						}
					}
					effect_for_scoped_reagent = {
						REAGENT = scope:current_reagent
						EFFECT = add_to_potential
					}
				}
			}
		}
	}

	# now that we have our different reagents, let's add them to the character
	every_in_list = {
		variable = ore_potential_current_batch
		save_scope_as = current_reagent
		scope:crafter = {
			#determine how many ores of this reagent you will get 
			random_list = {
				1 = { set_variable = { name = reagent_amount value = 10 } }
				20 = { set_variable = { name = reagent_amount value = 5 } }
				30 = { set_variable = { name = reagent_amount value = 4 } }
				40 = { set_variable = { name = reagent_amount value = 3 } }
				10 = { set_variable = { name = reagent_amount value = 2 } }
				5 = { set_variable = { name = reagent_amount value = 1 } }
			}
			effect_for_scoped_reagent = {
				REAGENT = scope:current_reagent
				EFFECT = discover_or_add_reagent_effect
			}
		}
	}

	remove_variable = potential_count
	remove_variable = reagent_amount
	remove_variable = ore_different_reagents
	remove_variable = will_discover_current_reagent
	clear_variable_list = ore_potential_current_batch
	clear_variable_list = reagents_here
}


add_to_location_list = {
	add_to_variable_list = { name = reagents_here target = flag:$REAGENT$ }
}

add_to_potential = {
	if = {
		limit = {
			var:potential_count < var:ore_different_reagents
		}
		add_to_variable_list = { name = last_discovered_reagents target = flag:$REAGENT$ }
		add_to_variable_list = { name = ore_potential_current_batch target = flag:$REAGENT$ }
		change_variable = {
			name = potential_count
			add = 1
		}
	}
}