wc_remove_secret_override = {
    if = {
        limit = {
            is_magic_secret_trigger = no
        }
        remove_secret = yes
    }
}

wc_event_chance_to_expose_secret_effect = { #Parameters: MAGICTYPE = magic school being tested, VALUE = base *percent* chance that secret will be exposed
    if = { 
        limit = { 
            OR = { 
                faith.has_doctrine = doctrine_$MAGICTYPE$_magic_shunned
                faith.has_doctrine = doctrine_$MAGICTYPE$_magic_crime
            }
        }
        random = { 
            chance = { 
                value = $VALUE$
                add = wc_event_spellcast_chance_to_expose_magic_secret_value
            }
            random_secret = { 
                limit = { 
                    secret_type = secret_$MAGICTYPE$_magic_user
                }
                expose_secret = root # oops i done exposed myself, hopefully there werent any kids around
            }
        }
    }
}

# Chance to expose this secret upon spellcasting, will add more in fire-lifestyle branch.
wc_expose_magic_spellcast_effect = {
	every_secret = {
		limit = {
			secret_type = secret_$MAGIC$_magic_user
		}
		save_scope_as = magic_secret
		root = {
			duel = {
				value = 15
				skill = intrigue
				70 = {
					# Spell rank
					modifier = {
						OR = {
							AND = {
								has_variable = current_spell_rank
								NOT = {
									has_variable = $SPELL$_rank
								}
								var:current_spell_rank = 2
							}
							AND = {
								has_variable = $SPELL$_rank
								var:$SPELL$_rank = 2
							}
						}
						factor = 0.7
					}
					modifier = {
						OR = {
							AND = {
								has_variable = current_spell_rank
								NOT = {
									has_variable = $SPELL$_rank
								}
								var:current_spell_rank = 3
							}
							AND = {
								has_variable = $SPELL$_rank
								var:$SPELL$_rank = 3
							}
						}
						factor = 0.5
					}
					# Number of targets
					modifier = {
						AND = {
							has_variable = $SPELL$_targets_list
							variable_list_size = {
								name = $SPELL$_targets_list
								value >= 2
							}
						}
						factor = 0.7
					}
					modifier = { 
                        add = { 
                            value = 0
                            subtract = wc_event_spellcast_chance_to_expose_magic_secret_value # add mitigation from perks, focuses, and other sources [SS
                        }
					}
					compare_modifier = {
						value = scope:duel_value
						multiplier = 3.5
						min = -49
					}
					# nothing
				}
				30 = {
					compare_modifier = {
						value = scope:duel_value
						multiplier = -3.5
						min = -49
					}
					scope:magic_secret = { expose_secret = root }
				}
			}
		}	
	}
}

# secret effects
wc_magic_lifestyle_secret_reveal_effect = { 
	if = { limit = { scope:secret = { secret_type = secret_light_magic_user } }
		wc_nonelemental_magic_lifestyle_rank_up_effect = { MAGIC = light }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_shadow_magic_user } }
		wc_nonelemental_magic_lifestyle_rank_up_effect = { MAGIC = shadow }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_life_magic_user } }
		wc_nonelemental_magic_lifestyle_rank_up_effect = { MAGIC = life }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_death_magic_user } }
		wc_nonelemental_magic_lifestyle_rank_up_effect = { MAGIC = death }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_order_magic_user } }
		wc_nonelemental_magic_lifestyle_rank_up_effect = { MAGIC = order }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_disorder_magic_user } }
		wc_nonelemental_magic_lifestyle_rank_up_effect = { MAGIC = disorder }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_elemental_earth_magic_user } }
		wc_elemental_magic_lifestyle_rank_up_effect = { MAGIC = elemental_earth }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_elemental_fire_magic_user } }
		wc_elemental_magic_lifestyle_rank_up_effect = { MAGIC = elemental_fire }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_elemental_air_magic_user } }
		wc_elemental_magic_lifestyle_rank_up_effect = { MAGIC = elemental_air }
	}
	else_if = { limit = { scope:secret = { secret_type = secret_elemental_water_magic_user } }
		wc_elemental_magic_lifestyle_rank_up_effect = { MAGIC = elemental_water }
	}
}