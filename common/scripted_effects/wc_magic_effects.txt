add_magic_infusion_effect = {
	save_scope_value_as = {
		name = magic_type
		value = flag:$MAGIC$
	}

	if = {
		limit = {
			NOT = {
				has_variable = $MAGIC$_infusion
			}
		}
		set_variable = {
			name = $MAGIC$_infusion
			value = 0
		}
	}

	change_variable = {
		name = $MAGIC$_infusion
		add = $ADD$
	}

	clamp_variable = { name = $MAGIC$_infusion max = 100 min = -100 }

	if = {
		limit = {
			scope:magic_type = flag:light_void
			$ADD$ > 0
		}
		custom_description = {
			text = "light_infusion_desc"
			value = $ADD$
		} 
		
		add_infusion_trait_xp_positive = { 
			MAGIC = $MAGIC$ 
			ADD = $ADD$
			TRAIT_POSITIVE = infusion_light 
			TRAIT_NEGATIVE = infusion_void 
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:light_void
			$ADD$ < 0
		}
		custom_description = {
			text = "shadow_infusion_desc"
			value = $ADD$
		} 
		
		add_infusion_trait_xp_negative = { 
			MAGIC = $MAGIC$ 
			ADD = $ADD$
			TRAIT_POSITIVE = infusion_light 
			TRAIT_NEGATIVE = infusion_void 
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:arcane_fel
			$ADD$ > 0
		}
		custom_description = {
			text = "arcane_infusion_desc"
			value = $ADD$
		}
		
		add_infusion_trait_xp_positive = { 
			MAGIC = $MAGIC$ 
			ADD = $ADD$
			TRAIT_POSITIVE = infusion_arcane
			TRAIT_NEGATIVE = infusion_fel 
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:arcane_fel
			$ADD$ < 0
		}
		custom_description = {
			text = "fel_infusion_desc"
			value = $ADD$
		}
		
		add_infusion_trait_xp_negative = { 
			MAGIC = $MAGIC$ 
			ADD = $ADD$
			TRAIT_POSITIVE = infusion_arcane 
			TRAIT_NEGATIVE = infusion_fel 
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:nature_death
			$ADD$ > 0
		}
		custom_description = {
			text = "nature_infusion_desc"
			value = $ADD$
		}
		
		add_infusion_trait_xp_positive = { 
			MAGIC = $MAGIC$ 
			ADD = $ADD$
			TRAIT_POSITIVE = infusion_life
			TRAIT_NEGATIVE = infusion_death
		}
	}
	else_if = {
		limit = {
			scope:magic_type = flag:nature_death
			$ADD$ < 0
		}
		custom_description = {
			text = "death_infusion_desc"
			value = $ADD$
		}
		
		add_infusion_trait_xp_negative = { 
			MAGIC = $MAGIC$ 
			ADD = $ADD$
			TRAIT_POSITIVE = infusion_life 
			TRAIT_NEGATIVE = infusion_death 
		}
	}

	infusion_traits_effect = { MAGIC = $MAGIC$ }
}

add_infusion_trait_xp_positive = { 
	if = {
		limit = {
			has_variable = $MAGIC$_infusion
		}
		if = {
			limit = {
				has_trait = $TRAIT_NEGATIVE$
			}
			add_trait_xp = {
				trait = $TRAIT_NEGATIVE$
				value = {
					value = $ADD$
					multiply = -1
				}
			}
			if = {
				limit = {
					var:$MAGIC$_infusion > 0
				}

				remove_trait = $TRAIT_NEGATIVE$
				add_trait = $TRAIT_POSITIVE$
				add_trait_xp = {
					trait = $TRAIT_POSITIVE$
					value = {
						value = var:$MAGIC$_infusion
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					NOT = {
						has_trait = $TRAIT_POSITIVE$
						has_trait = $TRAIT_NEGATIVE$
					}
				}

				add_trait = $TRAIT_POSITIVE$
				add_trait_xp = {
					trait = $TRAIT_POSITIVE$
					value = {
						value = var:$MAGIC$_infusion
					}
				}
			}

			add_trait_xp = {
				trait = $TRAIT_POSITIVE$
				value = {
					value = $ADD$
				}
			}
		}
	}
}

add_infusion_trait_xp_negative = {			
	if = {
		limit = {
			has_variable = $MAGIC$_infusion
		}
		if = {
			limit = {
				has_trait = $TRAIT_POSITIVE$
			}
			add_trait_xp = {
				trait = $TRAIT_POSITIVE$
				value = {
					value = $ADD$
				}
			}
			if = {
				limit = {
					var:$MAGIC$_infusion < 0
				}

				remove_trait = $TRAIT_POSITIVE$
				add_trait = $TRAIT_NEGATIVE$
				add_trait_xp = {
					trait = $TRAIT_NEGATIVE$
					value = {
						value = var:$MAGIC$_infusion
						multiply = -1
					}
				}
			}
		}
		else = {
			if = {
				limit = {
					NOT = {
						has_trait = $TRAIT_POSITIVE$
						has_trait = $TRAIT_NEGATIVE$
					}
				}

				add_trait = $TRAIT_NEGATIVE$
				add_trait_xp = {
					trait = $TRAIT_NEGATIVE$
					value = {
						value = var:$MAGIC$_infusion
						multiply = -1
					}
				}
			}

			add_trait_xp = {
				trait = $TRAIT_NEGATIVE$
				value = {
					value = $ADD$
					multiply = -1
				}
			}
		}
	}
}

infusion_traits_effect = {
	if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = $MAGIC$ AMOUNT = 3 }
		}
		if = {
			limit = {
				scope:magic_type = flag:light_void
			}
			trigger_event = WCINF.0001
		}
		else_if = {
			limit = {
				scope:magic_type = flag:arcane_fel
			}
			trigger_event = WCINF.0003
		}
		else_if = {
			limit = {
				scope:magic_type = flag:nature_death
			}
			trigger_event = WCINF.0005
		}
	}
	else_if = {
		limit = {
			has_infusion_level_trigger =  { MAGIC = $MAGIC$ AMOUNT = -3 }
		}
		if = {
			limit = {
				scope:magic_type = flag:light_void
			}
			trigger_event = WCINF.0002
		}
		else_if = {
			limit = {
				scope:magic_type = flag:nature_death
			}
			trigger_event = WCINF.0006
		}
	}
	
	if = {
		limit = {
			$MAGIC$_infusion_level_value < 2
		}
		if = {
			limit = {
				scope:magic_type = flag:light_void
				has_trait = being_light
			}
			trigger_event = WCINF.5001
		}
		else_if = {
			limit = {
				scope:magic_type = flag:arcane_fel
				has_trait = being_order
			}
			trigger_event = WCINF.5003
		}
		else_if = {
			limit = {
				scope:magic_type = flag:nature_death
				has_trait = being_life
			}
			trigger_event = WCINF.5005
		}
	}
	
	if = {
		limit = {
			$MAGIC$_infusion_level_value > -2
		}
		if = {
			limit = {
				scope:magic_type = flag:light_void
				has_trait = being_void
			}
			trigger_event = WCINF.5002
		}
		else_if = {
			limit = {
				scope:magic_type = flag:arcane_fel
				has_trait = being_demon
			}
			trigger_event = WCINF.5004
		}
		else_if = {
			limit = {
				scope:magic_type = flag:nature_death
				has_trait = being_undead
			}
			trigger_event = WCINF.5006
		}
	}
}

infusion_trait_duel_effect = {
	duel = {
		skill = $SKILL$
		value = 13
		
		10 = {
			desc = WCINF.$EVENT$.challenge.success
			compare_modifier = {
				value = scope:duel_value
				multiplier = 6
			}
			
			#trigger_event = WCINF.1001
			
			if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion > 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = -50 }
			}
			else_if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion < 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = 50 }
			}
		}
		
		15 = {
			desc = WCINF.$EVENT$.challenge.bad_success
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3
			}
			
			#trigger_event = WCINF.1001
			add_trait = lunatic_1
			
			stress_impact = {
				base = miniscule_stress_impact_gain
			}
			
			if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion > 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = -25 }
			}
			else_if = {
				limit = {
					has_variable = $MAGIC$_infusion
					var:$MAGIC$_infusion < 0
				}
				add_magic_infusion_effect = { MAGIC = $MAGIC$ ADD = 25 }
			}
		}
		
		25 = {
			desc = WCINF.$EVENT$.challenge.fail
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3
			}
			
			#trigger_event = WCINF.2001
			add_trait = $TRAIT$
			
			stress_impact = {
				base = minor_stress_impact_gain
			}
		}
		
		30 = {
			desc = WCINF.$EVENT$.challenge.bad_fail
			compare_modifier = {
				value = scope:duel_value
				multiplier = -6
			}
			
			#trigger_event = WCINF.2001
			add_trait = $TRAIT$
			add_trait = lunatic_1
			
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
}

add_collected_souls_effect = {
	if = {
		limit = {
			NOT = {
				has_variable = demon_sacrifices_needed
			}
		}
		set_variable = {
			name = demon_sacrifices_needed
			value = 0
		}
	}
	
	if = {
		limit = {
			NOT = {
				has_variable = collected_souls
			}
		}
		set_variable = {
			name = collected_souls
			value = 0
		}
	}
	
	if = {
		limit = {
			var:collected_souls < 0
		}
		
		set_variable = {
			name = collected_souls
			value = 0
		}
	}
	
	if = {
		limit = {
			OR = {
				$AMOUNT$ = 1
				$AMOUNT$ = -1
			}
		}
		custom_description = {
			text = ADD_SOUL
			value = $AMOUNT$
		}
	}
	else_if = {
		limit = {
			OR = {
				$AMOUNT$ > 0
				$AMOUNT$ < 0
			}
		}
		custom_description = {
			text = ADD_SOULS
			value = $AMOUNT$
		}
	}
	else = {
		custom_description = {
			text = ADD_SOUL
			value = $AMOUNT$
		}
	}
	change_variable = {
		name = collected_souls
		add = $AMOUNT$
	}
	
	if = {
		limit = {
			has_character_flag = demon_ritual
			var:collected_souls >= var:demon_sacrifices_needed
		}
		
		trigger_event = WCINF.4004
	}
}

demon_ritual_sacrifice_tooltip_effect = {
	custom_description = {
		text = demon_ritual_sacrifice_tooltip_effect
		value = $SACRIFICES$
	}
}