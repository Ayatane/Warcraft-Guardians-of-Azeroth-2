# Character Scope
# Calculates chance of finding reagent, then you can recall it in var:chance_current_reagent
# REAGENT = reagent flag e.g. flag:iron or something
# PROFESSION = profession e.g. mining or somehting
# This is for ores
chance_of_finding_reagent_effect = {
	set_variable = {
		name = chance_current_reagent
		value = 15
	}
	location = {
		save_scope_as = origin
	}
	change_variable = {
		name = chance_current_reagent
		add = {
			# By Reagent Location
			if = {
				limit = { province_has_reagent_trigger = { REAGENT = this } }
				value = 40
			}
			# By Rarity
			if = {
				limit = { reagent_rarity_is_very_common_trigger = { REAGENT = $REAGENT$ } }
				value = 20
			}
			if = {
				limit = { reagent_rarity_is_common_trigger = { REAGENT = $REAGENT$ } }
				value = 15
			}
			if = {
				limit = { reagent_rarity_is_uncommon_trigger = { REAGENT = $REAGENT$ } }
				value = 10
			}
			if = {
				limit = { reagent_rarity_is_rare_trigger = { REAGENT = $REAGENT$ } }
				value = 5
			}
			if = {
				limit = { reagent_rarity_is_exotic_trigger = { REAGENT = $REAGENT$ } }
				value = -5
			}
			if = {
				limit = { reagent_is_gem_trigger = { REAGENT = $REAGENT$ } }
			# 	Have to be prospected
				value = -500
			}
			#By Skill
			if = {
				limit = { var:$PROFESSION$_xp >= 90 }
				value = 10
			}
			if = {
				limit = { var:$PROFESSION$_xp >= 60 }
				value = 10
			}
			if = {
				limit = { var:$PROFESSION$_xp >= 90 }
				value = 10
			}
			if = {
				limit = { has_variable = knows_reagent_$REAGENT$ }
				value = -1000
			}
			#some rng
			value = { -10 15 }
		}
	}
}

add_starter_reagents_effect = {
	if = {
		#incase they switched back
		limit = { $PROFESSION$ = flag:mining }
		if = { limit = { NOT = { exists = var:Mining_items_made } }
			set_variable = {
				name = Mining_items_made
				value = 0
			}
			set_variable = {
				name = Blacksmithing_items_made
				value = 0
			}
		}
		discover_reagent_effect = { PROFESSION = flag:mining REAGENT = ore }
		discover_reagent_effect = { PROFESSION = flag:mining REAGENT = gold }
		discover_reagent_effect = { PROFESSION = flag:mining REAGENT = silver }
		discover_reagent_effect = { PROFESSION = flag:mining REAGENT = iron }	
	}
	
}

# REAGENTS AND INVENTORY
# ALL CHARACTER SCOPE
discover_reagent_effect = {
	set_variable = {
		name = current_reagent
		value = flag:$REAGENT$
	}
	if = { 
		limit = { $PROFESSION$ = flag:mining }
		if = {
			limit = { NOT = { exists = var:Mining_xp } }
			set_variable = {
				name = Mining_xp
				value = 1
			}
		}
		else = {
			change_variable = {
				name = Mining_xp
				add = 1
			}
		}
		add_trait_xp = {
			trait = profession_mining
			track = mining
			value = 1
		}
	}
	if = {
		limit = { NOT = { has_variable = knows_$REAGENT$ }}
		send_interface_message = {
			title = discovered_reagent_desc
			left_icon = root
			set_variable = {
				name = knows_$REAGENT$ 
				target = yes
			}
			change_variable = {
				name = known_reagents_count
				add = 1
			}
			set_variable = {
				name = last_discovered_reagent
				value = flag:$REAGENT$
			}
		}
	}
	remove_variable = current_reagent
}

remove_known_reagent = {
	remove_variable = knows_reagent_$REAGENT$ 
	remove_variable = $REAGENT$_amount
	if = {
		limit = { $TYPE$ = mining }
		remove_variable = $REAGENT$_amount_ore
		remove_variable = $REAGENT$_amount_bar
	}
}

add_reagent_to_inventory_effect = {
	if = {
		limit = { NOT = { has_variable = $REAGENT$_amount } }
		set_variable = {
			name = $REAGENT$_amount
			value = 0
		}
	}
	change_variable = {
		name = $REAGENT$_amount
		add = 1
	}
}

remove_reagent_from_inventory_effect = {
	change_variable = {
		name = $REAGENT$_amount
		add = -1
	}
}

add_ore_to_inventory_effect = {
	if = {
		limit = { NOT = { has_variable = $REAGENT$_amount_ore } }
		set_variable = {
			name = $REAGENT$_amount_ore
			value = 0
		}
	}
	change_variable = {
		name = $REAGENT$_amount_ore
		add = 1
	}
}

remove_ore_from_inventory_effect = {
	change_variable = {
		name = $REAGENT$_amount_ore
		add = -1
	}
}

smelt_reagent_effect = {
	change_variable = {
		name = $REAGENT$_amount_ore
		add = {
			value = var:batch_amount #eg. 10, removes 10 ores
			multiply = -1
		}
	}

	if = {
		limit = {
			NOT = { has_variable = $REAGENT$_amount_bar }
		}
		set_variable = {
			name = $REAGENT$_amount_bar
			value = 0
		}
	}

	change_variable = {
		name = $REAGENT$_amount_bar
		add = {
			value = var:batch_amount #e.g. 10, made 2 bars
			divide = 5	
		}
	}

	if = {
		limit = { # just in case
			NOT = { has_variable = $REAGENT$_amount }
		}
		set_variable = {
			name = $REAGENT$_amount
			value = 0
		}
	}

	set_variable = {
		name = $REAGENT$_amount
		value = {
			add = var:$REAGENT$_amount_bar
			add = var:$REAGENT$_amount_ore
		}
	}
	
	change_variable = {
		name = Mining_items_made
		add = {
			value = var:batch_amount #e.g. 10, made 2 bars
			divide = 5
		}
	}
	

	send_interface_toast = {
		title = smelt_success
	}
	
	#Remove if it's 0, because otherwise its just doing nothing
	if = {
		limit = { 
			var:$REAGENT$_amount_ore = 0
		}
		remove_variable = $REAGENT$_amount_ore
	}

	if = {
		limit = { 
			var:$REAGENT$_amount_bar = 0
		}
		remove_variable = $REAGENT$_amount_bar
	}
}

extract_ores_effect = {
	if = {
		limit = { has_list = inventory_ores }
		
	}
}

sell_reagent_effect = {
	determine_reagent_value_effect = {
		REAGENT = $REAGENT$
	}
	switch = {
		trigger = var:commerce_type
		flag:ore = {
			change_variable = {
				name = $REAGENT$_amount_ore
				add = {
					value = var:batch_amount
					multiply = -1
				}
			}
		}
		flag:bar = {
			change_variable = {
				name = $REAGENT$_amount_bar
				add = {
					value = var:batch_amount
					multiply = -1
				}
			}
		}
	}
	send_interface_toast = {
		title = sell_success
		add_short_term_gold = var:reagent_price
	}
	set_variable = {
		name = sell_cooldown
		value = yes
		days = 30
	}
	remove_variable = reagent_price
	if = {
		limit = { 
			var:$REAGENT$_amount_ore = 0
		}
		remove_variable = $REAGENT$_amount_ore
	}

	if = {
		limit = { 
			var:$REAGENT$_amount_bar = 0
		}
		remove_variable = $REAGENT$_amount_bar
	}
}

determine_reagent_value_effect = {
	# Calculate gold amount for reagent
	set_variable = {
		name = reagent_price
		value = 0
	}
	switch = {
		trigger = var:commerce_type
		flag:ore = {
			change_variable = {
				name = reagent_price
				add = 2
			}
		}
		flag:bar = {
			change_variable = {
				name = reagent_price
				add = 5
			}
		}
	}
	#By selling location
	# need to fix this
	if = {
		limit = {
			NOT = { location = { province_has_reagent_trigger = { REAGENT = flag:$REAGENT$ } } }
		}
		change_variable = {
			name = reagent_price
			add = 5
		}
	}
	#By rarity
	if = {
		limit = { 
			reagent_rarity_is_very_common_trigger = { REAGENT = flag:$REAGENT$ }
		}
		change_variable = {
			name = reagent_price
			add = 2
		}
	}
	if = {
		limit = { 
			reagent_rarity_is_common_trigger = { REAGENT = flag:$REAGENT$ }
		}
		change_variable = {
			name = reagent_price
			add = 8
		}
	}
	if = {
		limit = { 
			reagent_rarity_is_uncommon_trigger = { REAGENT = flag:$REAGENT$ }
		}
		change_variable = {
			name = reagent_price
			add = 10
		}
	}
	if = {
		limit = { 
			reagent_rarity_is_rare_trigger = { REAGENT = flag:$REAGENT$ }
		}
		change_variable = {
			name = reagent_price
			add = 13
		}
	}
	if = {
		limit = { 
			reagent_rarity_is_exotic_trigger = { REAGENT = flag:$REAGENT$ }
		}
		change_variable = {
			name = reagent_price
			add = 20
		}
	}
	#inflation
	if = {
		limit = {
			has_character_flag = sold_crap_ton_of_$REAGENT$_recently
		}
		change_variable = {
			name = reagent_price
			add = -40
		}
	}
	if = {
		limit = {
			has_character_flag = sold_alot_of_$REAGENT$_recently
		}
		change_variable = {
			name = reagent_price
			add = -25
		}
	}
	if = {
		limit = {
			has_character_flag = sold_$REAGENT$_recently
		}
		change_variable = {
			name = reagent_price
			add = -10
		}
	}
	if = {
		limit = { var:reagent_price <= 0 }
		set_variable = {
			name = reagent_price
			value = 2
		}
	}
	change_variable = {
		name = reagent_price
		value = {
			multiply = var:batch_amount #e.g. 5 gold each, selling 10, get 50g
		}
	}
	#add flags
	if = {
		limit = {
			var:batch_amount <= 10
			NOT = { has_character_flag = sold_$REAGENT$_recently }
		}
		add_character_flag = {
			flag = sold_$REAGENT$_recently
			days = 60
		}
	}
	if = {
		limit = {
			OR = {
				var:batch_amount >= 10
				AND = {
					var:batch_amount <= 10
					has_character_flag = sold_$REAGENT$_recently 
				}
			}
		}
		add_character_flag = {
			flag = sold_alot_of_$REAGENT$_recently
			days = 60
		}
	}
	if = {
		limit = {
			OR = {
				var:batch_amount >= 25
				AND = {
					var:batch_amount <= 10
					has_character_flag = sold_alot_of_$REAGENT$_recently 
				}
			}
		}
		add_character_flag = {
			flag = sold_crap_ton_of_$REAGENT$_recently
			days = 75
		}
	}
}

#effect or trigger for reagent 
modify_reagent_effect = {
	switch = {
		trigger = $REAGENT$
		flag:ore = { $EFFECT$ = { REAGENT = ore } }
		flag:thorium = { $EFFECT$ = { REAGENT = thorium } }
		flag:obsidium = { $EFFECT$ = { REAGENT = obsidium } }
		flag:gold = { $EFFECT$ = { REAGENT = gold } }
		flag:pyrite = { $EFFECT$ = { REAGENT = pyrite } }
		flag:elementium = { $EFFECT$ = { REAGENT = elementium } }
		flag:iron = { $EFFECT$ = { REAGENT = iron } }
		flag:silver = { $EFFECT$ = { REAGENT = silver } }
		flag:titansteel = { $EFFECT$ = { REAGENT = titansteel } }
		flag:ghost_iron = { $EFFECT$ = { REAGENT = ghost_iron } }
		flag:leystone = { $EFFECT$ = { REAGENT = leystone } }
		flag:cobalt = { $EFFECT$ = { REAGENT = cobalt } }
		flag:khorium = { $EFFECT$ = { REAGENT = khorium } }
		flag:felsteel = { $EFFECT$ = { REAGENT = felsteel } }
		flag:earthen = { $EFFECT$ = { REAGENT = earthen } }
		flag:mithril = { $EFFECT$ = { REAGENT = mithril } }
		flag:kyparite = { $EFFECT$ = { REAGENT = kyparite } }
		flag:nethercite = { $EFFECT$ = { REAGENT = nethercite } }
		flag:emerald = { $EFFECT$ = { REAGENT = emerald } }
		flag:opal = { $EFFECT$ = { REAGENT = opal } }
		flag:diamond = { $EFFECT$ = { REAGENT = diamond } }
		flag:amethyst = { $EFFECT$ = { REAGENT = amethyst } }
		flag:night_stone = { $EFFECT$ = { REAGENT = night_stone } }
		flag:mojo_stone = { $EFFECT$ = { REAGENT = mojo_stone } }
		flag:mana_stone = { $EFFECT$ = { REAGENT = mana_stone } }
		flag:ruby = { $EFFECT$ = { REAGENT = ruby } }
		flag:lapis_lazuli = { $EFFECT$ = { REAGENT = lapis_lazuli } }
	}
}

init_mining_reagents_effect = {
	# Blacksmithing + Mining Reagents
	add_to_global_variable_list = { name = mining_reagents target = flag:ore }
	add_to_global_variable_list = { name = mining_reagents target = flag:thorium }
	add_to_global_variable_list = { name = mining_reagents target = flag:obsidium }
	add_to_global_variable_list = { name = mining_reagents target = flag:gold }
	add_to_global_variable_list = { name = mining_reagents target = flag:pyrite }
	add_to_global_variable_list = { name = mining_reagents target = flag:elementium }
	add_to_global_variable_list = { name = mining_reagents target = flag:iron }
	add_to_global_variable_list = { name = mining_reagents target = flag:silver }
	add_to_global_variable_list = { name = mining_reagents target = flag:saronite }
	add_to_global_variable_list = { name = mining_reagents target = flag:titansteel }
	add_to_global_variable_list = { name = mining_reagents target = flag:ghost_iron }
	add_to_global_variable_list = { name = mining_reagents target = flag:draconium }
	add_to_global_variable_list = { name = mining_reagents target = flag:leystone }
	add_to_global_variable_list = { name = mining_reagents target = flag:cobalt }
	add_to_global_variable_list = { name = mining_reagents target = flag:khorium }
	add_to_global_variable_list = { name = mining_reagents target = flag:felsteel }
	add_to_global_variable_list = { name = mining_reagents target = flag:earthen }
	add_to_global_variable_list = { name = mining_reagents target = flag:mithril }
	add_to_global_variable_list = { name = mining_reagents target = flag:kyparite }
	add_to_global_variable_list = { name = mining_reagents target = flag:titanium }
	add_to_global_variable_list = { name = mining_reagents target = flag:nethercite }
	add_to_global_variable_list = { name = mining_reagents target = flag:emerald }
	add_to_global_variable_list = { name = mining_reagents target = flag:opal }
	add_to_global_variable_list = { name = mining_reagents target = flag:diamond }
	add_to_global_variable_list = { name = mining_reagents target = flag:amethyst }
	add_to_global_variable_list = { name = mining_reagents target = flag:night_stone }
	add_to_global_variable_list = { name = mining_reagents target = flag:mojo_stone }
	add_to_global_variable_list = { name = mining_reagents target = flag:mana_stone }
	add_to_global_variable_list = { name = mining_reagents target = flag:ruby }
	add_to_global_variable_list = { name = mining_reagents target = flag:lapis_lazuli }

	add_to_global_variable_list = { name = mining_reagents_types target = flag:bar }

	set_global_variable = { name = mining_reagents_done value = yes }
}

