wc_show_mana_gui = { scope = character is_shown = { wc_max_mana_value > 0 } } # Used to show/hide the entire interface

open_spellbook_sgui = {
	scope = character

	effect = {
		if = {
			limit = {
				NOT = { exists = global_var:spellbook_init }
			}
			init_elemental_fire_spells_effect = yes

			# set_global_variable = spellbook_init
		}
		# Temporary list so spell types will be displayed
		add_to_variable_list = { name = spell_types target = flag:light }
		add_to_variable_list = { name = spell_types target = flag:shadow }
		add_to_variable_list = { name = spell_types target = flag:life }
		add_to_variable_list = { name = spell_types target = flag:death }
		add_to_variable_list = { name = spell_types target = flag:order }
		add_to_variable_list = { name = spell_types target = flag:disorder }
		add_to_variable_list = { name = spell_types target = flag:elemental_earth }
		add_to_variable_list = { name = spell_types target = flag:elemental_air }
		add_to_variable_list = { name = spell_types target = flag:elemental_fire }
		add_to_variable_list = { name = spell_types target = flag:elemental_water }

		add_to_variable_list = { name = spell_elemental_types target = flag:decay }
		add_to_variable_list = { name = spell_elemental_types target = flag:spirit }

		add_to_variable_list = { name = spell_ranks target = flag:rank_1 }
		add_to_variable_list = { name = spell_ranks target = flag:rank_2 }
		add_to_variable_list = { name = spell_ranks target = flag:rank_3 }

	}
}

close_spellbook_sgui = {
	scope = character 
	effect = {
		# Remove all spell-related variables
		remove_variable = current_spell_name
		remove_variable = current_spell_rank
		remove_variable = current_spell_class
		remove_variable = current_target_type
		remove_variable = elemental_type

		remove_variable = spellbook_open
		clear_variable_list = spell_types
		clear_variable_list = elemental_types
		clear_variable_list = spell_ranks

		remove_variable = spell_recipient
		remove_variable = spellbook_type_cast
		remove_variable = spellbook_type_view
		remove_variable = spell_targets_list
	}
}

set_current_spell_class_sgui = {
	scope = character 
	saved_scopes = { class } 
	effect = {
		set_variable = {
			name = current_spell_class
			value = scope:class
		}
	}
}

set_current_spell_sgui = {
	scope = character
	saved_scopes = { spell } 
	effect = {
		set_variable = {
			name = current_spell_name
			value = scope:spell
		}
		if = {
			limit = { NOT = { has_variable = current_spell_rank } }
			set_variable = {
				name = current_spell_rank
				value = 1
			}
		}
		# getting the target type by rank
		if = {
			limit = { spell_target_is_character_list_trigger = { SPELL_NAME = var:current_spell_name RANK_VALUE = var:current_spell_rank } }
			set_variable = { name = current_target_type value = flag:character_list }
		}
		else_if = {
			limit = { spell_target_is_province_or_title_trigger = { SPELL_NAME = var:current_spell_name RANK_VALUE = var:current_spell_rank } }
			set_variable = { name = current_target_type value = flag:title }
		}
		else_if = {
			limit = { spell_target_is_character_trigger = { SPELL_NAME = var:current_spell_name RANK_VALUE = var:current_spell_rank } }
			set_variable = { name = current_target_type value = flag:character }
		}
		else_if = {
			limit = { spell_target_is_province_or_title_list_trigger = { SPELL_NAME = var:current_spell_name RANK_VALUE = var:current_spell_rank } }
			set_variable = { name = current_target_type value = flag:title_list }
		}
	}
}

set_spell_rank_sgui = {
	scope = character
	saved_scopes = { function } 
	effect = {
		switch = {
			trigger = scope:function
			flag:rank_1 = {
				set_variable = {
					name = current_spell_rank
					value = 1
				}
			}
			flag:rank_2 = {
				set_variable = {
					name = current_spell_rank
					value = 2
				}
			}
			flag:rank_3 = {
				set_variable = {
					name = current_spell_rank
					value = 3
				}
			}
		}
	}
}

set_spirit_decay_sgui = {
	scope = character
	saved_scopes = { function } 
	effect = {
		set_variable = {
			name = elemental_type
			value = scope:function
		}
	}
}

is_spell_elemental_sgui = {
	scope = character
	is_valid = {
		spell_is_elemental_trigger = { SPELL_NAME = var:current_spell_name  }
	}
}

does_spell_have_ranks_sgui = {
	scope = character
	is_valid = {
		spell_has_ranks_trigger = { SPELL_NAME = var:current_spell_name  }
	}
}

clear_selected_spell_sgui = {
	scope = character
	effect = {
		remove_variable = current_spell_name
	}
}

knows_spell_sgui = {
	scope = character 
	is_valid = {
		NOT = {
			is_unknown_spell_trigger = {
				SPELL_NAME = var:current_spell_name
			}
		}
	}
}

has_unlocked_spell_rank_sgui = {
	scope = character 
	saved_scopes = { spell_rank }
	has_unlocked_spell_rank_trigger = {
		SPELL_NAME = var:current_spell_name
		SPELL_RANK = scope:spell_rank
	}
}

can_cast_spell_sgui = {
	# checking for all parameters
	scope = character 

	is_valid = {
		NOT = { # Just to be safe
			is_unknown_spell_trigger = {
				SPELL_NAME = var:current_spell_name
			}
		} 
		has_unlocked_spell_rank_trigger = { # Just to be safe
			SPELL_NAME = var:current_spell_name
			SPELL_RANK = var:current_spell_rank
		}
		OR = {
			AND = {
				has_variable_list = spell_targets_list
				every_in_list = {
					variable = spell_targets_list
					save_scope_as = spell_target
					can_cast_spell_trigger = {
						SPELL_NAME = var:current_spell_name
						TARGET = scope:spell_target
					}
				}
			}
			can_cast_spell_trigger = {
				SPELL_NAME = var:current_spell_name
				TARGET = scope:spell_recipient # can be character or title
			}
		}
	}
}

set_target_or_add_sgui = {
	scope = character 
	saved_scopes = { spell_target }
	effect = {
		if = {
			limit = {
				OR = {
					var:current_target_type = flag:character_list
					var:current_target_type = flag:title_list
				}
			}
			add_to_variable_list = {
				name = spell_targets_list
				target = scope:spell_target
			}
		}
		else = {
			set_variable = {
				name = spell_recipient
				value = scope:spell_target
			}
		}
	}
}

remove_target_sgui = {
	scope = character 
	saved_scopes = { spell_target }
	effect = {
		if = {
			limit = {
				OR = {
					var:current_target_type = flag:character_list
					var:current_target_type = flag:title_list
				}
			}
			remove_list_variable = {
				name = spell_targets_list
				target = scope:spell_target
			}
		}
		else = {
			remove_variable = spell_recipient
		}
	}
}

is_spell_target_valid_sgui = {
	scope = character 
	saved_scopes = { target }
	is_valid = {
		OR = {
			AND = { # If you can only cast on yourself, then it has to be you
				spell_target_is_only_self_trigger = { SPELL_NAME = var:current_spell_name }
				var:spell_recipient = root
			}
			exists = scope:target
			list_size:spell_targets_list = 3 # Target cap cannot be reached
			NOT = { any_in_list = { variable = spell_targets_list this = scope:target } } # Cant be already targeted
		}
	}
}

cast_spell_sgui = {
	scope = character 
	effect = {
		execute_scoped_spell_effect = {
			EFFECT = start_spell_casting_effect
			SPELL = var:current_spell_name
		}
	}
}