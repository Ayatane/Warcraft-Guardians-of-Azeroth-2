namespace = wc_religious_decision

scripted_effect wc_religious_decision_0001_count_converts_effect = {
	if = {
		limit = { exists = var:schismed_faith_major_ruler_converted_count }
		custom_tooltip = wc_religious_decision.0001.tt.some_rulers_converted_away
	}
	else = { custom_tooltip = wc_religious_decision.0001.tt.all_rulers_stayed }
}

scripted_effect wc_religious_decision_0001_count_stay_effect = {
	if = {
		limit = { exists = var:schismed_faith_major_ruler_stayed_count }
		custom_tooltip = wc_religious_decision.0001.tt.some_rulers_stayed
	}
	else = { custom_tooltip = wc_religious_decision.0001.tt.no_rulers_stayed }
}

#	Scope:founder's POV - oops, you've caused a schism!
wc_religious_decision.0001 = {
	type = character_event
	title = wc_religious_decision.0001.t
	desc = wc_religious_decision.0001.desc
	theme = faith
	left_portrait = {
		character = scope:founder
		animation = personality_bold
	}
	right_portrait = {
		character = scope:old_religious_head
		animation = fear
	}

	immediate = {
		play_music_cue = "mx_cue_faith_conversion"
		# Execute the actual effects.
		show_as_tooltip = {
			custom_description = {
				text = separate_from_zul_new_hof
			}

			separate_from_zul_other_effect = yes
		}
	}

	# Hah, take *that* scope:old_religious_head!
	option = {
		name = wc_religious_decision.0001.a

		# Inform scope:founder how many, if any, folks rejected their coup.
		wc_religious_decision_0001_count_converts_effect = yes
		wc_religious_decision_0001_count_stay_effect = yes

		# No stress impact, choice is narrative.
		ai_chance = {
			# AI chance is irrelevant, as the options are cosmetic.
			base = 100
		}
	}

	after = {
		# Clean up the variable count, if required.
		if = {
			limit = { exists = var:schismed_faith_major_ruler_converted_count }
			remove_variable = schismed_faith_major_ruler_converted_count
		}
	}
}

#	Co-faithist POV - uhhh, there's a new HoF in town?
wc_religious_decision.0002 = {
	type = character_event
	title = wc_religious_decision.0002.t
	desc = wc_religious_decision.0002.desc
	theme = faith
	left_portrait = {
		character = scope:founder
		animation = personality_zealous
	}
	right_portrait = {
		character = scope:old_religious_head
		animation = rage
	}

	immediate = {
		play_music_cue = "mx_cue_faith_conversion"
		# Plus grab the current faith for loc.
		faith = { save_scope_as = current_faith }
		# Show the effects of the schism.
		show_as_tooltip = {
			scope:founder = { 
				custom_description = {
					text = separate_from_zul_new_hof
				}

				separate_from_zul_other_effect = yes
			}
		}
	}

	# Scope:founder shall lead us to PositiveAfterLife!
	option = {
		name = wc_religious_decision.0002.a

		custom_tooltip = wc_religious_decision.0002.a.tt

		# Make a note that a major character chose to stay rather than convert.
		scope:founder = {
			if = {
				limit = {
					NOT = { exists = var:schismed_faith_major_ruler_stayed_count }
				}
				set_variable = {
					name = schismed_faith_major_ruler_stayed_count
					value = 1
				}
			}
			else = {
				change_variable = {
					name = schismed_faith_major_ruler_stayed_count
					add = 1
				}
			}
		}

		# No stress impact, as zealous and cynical could come down on either side here.
		ai_chance = {
			base = 0
			opinion_modifier = {
				opinion_target = scope:founder
				multiplier = 5
			}
			# Distant caliphs are less respected.
			modifier = {
				add = 100
				OR = { 
					in_diplomatic_range = scope:new_religious_head
					in_diplomatic_range = scope:founder
				}
				NOT = { in_diplomatic_range = scope:old_religious_head }
			}
		}
	}

	# Never: my loyalty to scope:old_religious_head outweighs my loyalty to scope:current_faith!
	option = {
		name = wc_religious_decision.0002.b
		# We're not fussed about much, but very young kids don't really get a choice in this.
		trigger = { age >= 8 }

		# Convert to scope:old_religious_head's faith.
		set_character_faith_with_conversion = scope:old_religious_head.faith
		# Make a note that a major character chose to convert rather than toe the line.
		scope:founder = {
			if = {
				limit = {
					NOT = { exists = var:schismed_faith_major_ruler_converted_count }
				}
				set_variable = {
					name = schismed_faith_major_ruler_converted_count
					value = 1
				}
			}
			else = {
				change_variable = {
					name = schismed_faith_major_ruler_converted_count
					add = 1
				}
			}
		}

		# No stress impact, as zealous and cynical could come down on either side here.
		ai_chance = {
			base = 0
			opinion_modifier = {
				opinion_target = scope:old_religious_head
				multiplier = 5
			}
			# Caliphs within writing distance are more respected.
			modifier = {
				add = 100
				in_diplomatic_range = scope:old_religious_head
				NOT = { 
					in_diplomatic_range = scope:new_religious_head
				}
				NOT = { 
					in_diplomatic_range = scope:founder
				}
			}
			# Heirs to scope:founder won't voluntarily disinherit themselves unless they're zealous.
			modifier = {
				factor = 0
				NOT = { has_trait = zealous }
				any_heir_title = { holder = scope:founder }
			}
		}
	}

	# People seem desperate for a true leader...
	option = {
		name = wc_religious_decision.0002.c
		trigger = { is_ai = no }

		# It becomes cheaper to make your own faith for a while.
		add_character_modifier = {
			modifier = fp2_opportunistic_schismatic_modifier
			years = 25
		}

		# No stress impact, as zealous and cynical could come down on either side here.
		ai_chance = {
			# AI chance irrelevant, since the AI doesn't use the relevant feature.
			base = 100
		}
	}
}

#	Other POV - bit dramatic, mate.
wc_religious_decision.0003 = {
	type = character_event
	title = wc_religious_decision.0003.t
	desc = wc_religious_decision.0003.desc
	theme = faith
	left_portrait = {
		character = scope:founder
		animation = personality_zealous
	}
	right_portrait = {
		character = scope:old_religious_head
		animation = rage
	}

	immediate = {
		play_music_cue = "mx_cue_faith_conversion"
		# Show the effects of the schism.
		show_as_tooltip = {
			scope:founder = { appoint_a_righteous_caliph_scripted_effect = yes }
		}
	}

	# Scope:old_religious_head's POV - Fiend! Cur! Blasphemer!
	option = {
		name = wc_religious_decision.0003.a
		trigger = { this = scope:old_religious_head }

		# No stress impact, choice is narrative.
		ai_chance = {
			# AI chance is irrelevant, since the choice is narrative.
			base = 100
		}
	}

	# Other co-religionist's POV - Scope:old_religious_head cannot keep HerHis house in order...
	option = {
		name = wc_religious_decision.0003.b
		trigger = {
			NOT = { this = scope:old_religious_head }
			religion = religion:loa_group
		}

		# No stress impact, choice is narrative.
		ai_chance = {
			# AI chance is irrelevant, since the choice is narrative.
			base = 100
		}
	}

	# Neighbouring Ruler POV: Ha! What high drama!
	option = {
		name = wc_religious_decision.0003.c
		trigger = {
			NOT = { religion = religion:loa_group }
		}

		# No stress impact, choice is narrative.
		ai_chance = {
			# AI chance is irrelevant, since the choice is narrative.
			base = 100
		}
	}
}
