namespace = magic_secret

##################################################################
# 0001 - 0999 : Upon Gaining Magic Secret Events
# (one year or less)
##################################################################

magic_secret.0001 = { 
	type = character_event
	title = { 
		first_valid = { 
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_light_magic_user}  }
				desc = magic_secret.0001.title.light 
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_shadow_magic_user}  }
				desc = magic_secret.0001.title.shadow
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_order_magic_user}  }
				desc = magic_secret.0001.title.order
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_disorder_magic_user}  }
				desc = magic_secret.0001.title.disorder
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_life_magic_user}  }
				desc = magic_secret.0001.title.life
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_death_magic_user}  }
				desc = magic_secret.0001.title.death
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_fire_magic_user}  }
				desc = magic_secret.0001.title.fire
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_water_magic_user}  }
				desc = magic_secret.0001.title.water
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_air_magic_user}  }
				desc = magic_secret.0001.title.air
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_earth_magic_user}  }
				desc = magic_secret.0001.title.earth
			}
			desc = magic_secret.0001.title
		}
	}

	desc = { 
		first_valid = { 
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_light_magic_user}  }
				desc = magic_secret.0001.desc.light
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_shadow_magic_user}  }
				desc = magic_secret.0001.desc.shadow
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_order_magic_user}  }
				desc = magic_secret.0001.desc.order
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_disorder_magic_user}  }
				desc = magic_secret.0001.desc.disorder
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_life_magic_user}  }
				desc = magic_secret.0001.desc.life
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_death_magic_user}  }
				desc = magic_secret.0001.desc.death
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_fire_magic_user}  }
				desc = magic_secret.0001.desc.fire
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_water_magic_user}  }
				desc = magic_secret.0001.desc.water
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_air_magic_user}  }
				desc = magic_secret.0001.desc.air
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_earth_magic_user}  }
				desc = magic_secret.0001.desc.earth
			}
		}
	}

	# high intrigue
	option = { 
		show_as_unavailable = { 
			OR = { 
				AND = { 
					intrigue >= high_skill_rating 
					intrigue < very_high_skill_rating 
				}
				AND = { 
					intrigue_lifestyle_perks > 0
					NOR = { 
						has_perk = dreadful_perk
						has_perk = court_of_shadows_perk
					}
				}
			}
		}
		trigger = { 
			OR = { 
				intrigue >= very_high_skill_rating
				has_perk = dreadful_perk
				has_perk = court_of_shadows_perk
			}
		}
		name = magic_secret.0001.opt.intrigue
		set_variable = { 
			name = wc_magic_secret_expose_chance
			value = {
				value = intrigue
				subtract = high_skill_rating
				multiply = 2
			}
			years = 2
		}
	}

	# high diplomacy
	option = { 
		show_as_unavailable = { 
			OR = { 
				AND = { 
					diplomacy >= high_skill_rating 
					diplomacy < very_high_skill_rating 
				}
				AND = { 
					diplomacy_lifestyle_perks > 0
					NOR = { 
						has_perk = dignitas_perk
						has_perk = confidants_perk
					}
				}
			}
		}
		trigger = { 
			OR = { 
				diplomacy >= very_high_skill_rating
				has_perk = dignitas_perk
				has_perk = confidants_perk
			}
		}
		name = magic_secret.0001.opt.diplomacy
		set_variable = { 
			name = wc_magic_secret_expose_chance
			value = {
				value = diplomacy
				subtract = high_skill_rating
				multiply = 2
			}
			years = 2
		}
	}

	# high martial
	option = { 
		show_as_unavailable = { 
			OR = { 
				AND = { 
					martial >= high_skill_rating 
					martial < very_high_skill_rating 
				}
				AND = { 
					martial_lifestyle_perks > 0
					NOR = { 
						has_perk = hard_rule_perk
						has_perk = loyalty_and_respect_perk
					}
				}
			}
		}
		trigger = { 
			OR = { 
				martial >= very_high_skill_rating
				has_perk = hard_rule_perk
				has_perk = loyalty_and_respect_perk
			}
		}
		name = magic_secret.0001.opt.martial
		set_variable = { 
			name = wc_magic_secret_expose_chance
			value = {
				value = martial
				subtract = high_skill_rating
				multiply = 2
			}
			years = 2
		}
	}

	#high stewardship
	option = { 
		show_as_unavailable = { 
			OR = { 
				AND = { 
					stewardship >= high_skill_rating 
					stewardship < very_high_skill_rating 
				}
				AND = { 
					stewardship_lifestyle_perks > 0
					NOT = { has_perk = toe_the_line_perk }
				}
			}
		}
		trigger = { 
			OR = { 
				stewardship >= very_high_skill_rating
				has_perk = toe_the_line_perk
			}
		}
		name = magic_secret.0001.opt.stewardship
		set_variable = { 
			name = wc_magic_secret_expose_chance
			value = {
				value = stewardship
				subtract = high_skill_rating
				multiply = 2
			}
			years = 2
		}
	}

	#high learning
	option = { 
		show_as_unavailable = { 
			OR = { 
				AND = { 
					learning >= high_skill_rating 
					learning < very_high_skill_rating 
				}
				AND = { 
					learning_lifestyle_perks > 0
					NOT = { has_perk = toe_the_line_perk }
				}
			}
		}
		trigger = { 
			OR = { 
				learning >= very_high_skill_rating
				has_perk = toe_the_line_perk
			}
		}
		name = magic_secret.0001.opt.learning
		set_variable = { 
			name = wc_magic_secret_expose_chance
			value = {
				value = learning
				subtract = high_skill_rating
				multiply = 2
			}
			years = 2
		}
	}

	#normal loser
	option = { 
		set_variable = { 
			name = wc_magic_secret_expose_chance
			value = 5
			years = 2
		}
		name = magic_secret.0001.opt.normal
	}
}

##################################################################
# 1000 - 1999 : Magic Secret Discovery Events
# (one year or less) - By Shatterstar
##################################################################

# magic secret exposed - owner
magic_secret.1001 = { 
	type = character_event
	title = { 
		first_valid = { 
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_light_magic_user}  }
				desc = magic_secret.1001.title.light 
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_shadow_magic_user}  }
				desc = magic_secret.1001.title.shadow
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_order_magic_user}  }
				desc = magic_secret.1001.title.order
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_disorder_magic_user}  }
				desc = magic_secret.1001.title.disorder
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_life_magic_user}  }
				desc = magic_secret.1001.title.life
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_death_magic_user}  }
				desc = magic_secret.1001.title.death
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_fire_magic_user}  }
				desc = magic_secret.1001.title.fire
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_fire_spirit_magic_user}  }
			# 	desc = magic_secret.1001.title.fire_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_fire_decay_magic_user}  }
			# 	desc = magic_secret.1001.title.fire_d
			# }
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_water_magic_user}  }
				desc = magic_secret.1001.title.water
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_water_spirit_magic_user}  }
			# 	desc = magic_secret.1001.title.water_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_water_decay_magic_user}  }
			# 	desc = magic_secret.1001.title.water_d
			# }
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_air_magic_user}  }
				desc = magic_secret.1001.title.air
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_air_spirit_magic_user}  }
			# 	desc = magic_secret.1001.title.air_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_air_decay_magic_user}  }
			# 	desc = magic_secret.1001.title.air_d
			# }
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_earth_magic_user}  }
				desc = magic_secret.1001.title.earth
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_earth_spirit_magic_user}  }
			# 	desc = magic_secret.1001.title.earth_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_earth_decay_magic_user}  }
			# 	desc = magic_secret.1001.title.earth_d
			# }
			desc = magic_secret.1001.title
		}
	}

	desc = { 
		first_valid = { 
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_light_magic_user}  }
				desc = magic_secret.1001.desc.light
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_shadow_magic_user}  }
				desc = magic_secret.1001.desc.shadow
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_order_magic_user}  }
				desc = magic_secret.1001.desc.order
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_disorder_magic_user}  }
				desc = magic_secret.1001.desc.disorder
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_life_magic_user}  }
				desc = magic_secret.1001.desc.life
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_death_magic_user}  }
				desc = magic_secret.1001.desc.death
			}
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_fire_magic_user}  }
				desc = magic_secret.1001.desc.fire
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_fire_spirit_magic_user}  }
			# 	desc = magic_secret.1001.desc.fire_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_fire_decay_magic_user}  }
			# 	desc = magic_secret.1001.desc.fire_d
			# }
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_water_magic_user}  }
				desc = magic_secret.1001.desc.water
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_water_spirit_magic_user}  }
			# 	desc = magic_secret.1001.desc.water_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_water_decay_magic_user}  }
			# 	desc = magic_secret.1001.desc.water_d
			# }
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_air_magic_user}  }
				desc = magic_secret.1001.desc.air
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_air_spirit_magic_user}  }
			# 	desc = magic_secret.1001.desc.air_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_air_decay_magic_user}  }
			# 	desc = magic_secret.1001.desc.air_d
			# }
			triggered_desc = {
				trigger = { scope:secret = {secret_type = secret_elemental_earth_magic_user}  }
				desc = magic_secret.1001.desc.earth
			}
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_earth_spirit_magic_user}  }
			# 	desc = magic_secret.1001.desc.earth_s
			# }
			# triggered_desc = {
			# 	trigger = { scope:secret = {secret_type = secret_elemental_earth_decay_magic_user}  }
			# 	desc = magic_secret.1001.desc.earth_d
			# }
		}
	}

	theme = secret
	left_portrait = scope:secret_exposer
	
	immediate = {
		secret_exposed_owner_effects_effect = { SECRET = scope:secret POV = root }
		secret_exposed_owner_opinion_effects_effect = yes
		play_music_cue = "mx_cue_secret"
		wc_magic_lifestyle_secret_reveal_effect = yes
	}

	option = {
		name = magic_secret.1001.opt.a

		hidden_effect = { 
			scope:secret_owner = { 
				save_list_targets_for_secret_exposure_events_effect = { SECRET = scope:secret CHARACTER = scope:secret_owner }
			}

			every_in_list = { 
				list = send_exposed_secret_event_list
				trigger_event = magic_secret.1011
			}
		}
	}
}

# magic secret exposed - family/friend
magic_secret.1011 = { 
	type = character_event
	title = magic_secret.1011.title
	desc = magic_secret.1011.desc

	theme = secret

	option = { 
		name = { 
			text = {
				first_valid = {
					triggered_desc = { 
						trigger = {
							#OR = { 
								#any_secret = { secret_type = scope:secret.secret_type }
								scope:secret = { has_magic_secret_associated_trait = { CHARACTER = root } }
							#}
						}
						desc = magic_secret.1011.opt.a.sympathetic
					}
					triggered_desc = { 
						trigger = {
							has_trait = lazy has_trait = eccentric has_trait = cynical
						}
						desc = magic_secret.1011.opt.a.indifferent
					}
					triggered_desc = { 
						trigger = {}
						desc = magic_secret.1011.opt.a.hostile
					}
				}
			}
		}

	}

	# liege - imprison
	option = { 
		name = magic_secret.1011.opt.b 
		trigger = { allowed_to_imprison_character_trigger = { CHARACTER = scope:owner } }

		imprison_character_effect = {
			TARGET = scope:owner
			IMPRISONER = root
		}

		if = { 
			limit = { scope:secret = { has_magic_secret_associated_trait = { CHARACTER = root } } }
			stress_impact = { 
				base = medium_stress_impact_gain
				callous = miniscule_stress_impact_gain
				arbitrary = miniscule_stress_impact_gain
			}
		}
	}

	#family member - denounce
	option = { 
		name = { 
			first_valid = {
				triggered_desc = { 
					trigger = { 
						scope:secret_owner = { 
							any_close_family_member = { this = root }
						}
					}
					desc = magic_secret.1011.opt.c
				}
			}
		}
		scope:secret_owner = { 
			if = { 
				limit = { has_fp3_dlc_trigger = yes }
				add_opinion = {
					target = root
					modifier = fp3_denounced_me
				}
			}
			else = { 
				add_opinion = {
					target = root
					modifier = angry_opinion
					opinion = 30
				}
			}
		}
		add_piety = 25
		ai_chance = { 
			base = 25
			ai_value_modifier = {
				ai_compassion = -1.5
				ai_boldness = 1.5 
				ai_zeal = 3
			}
		}
	}

	#family member - support
	option = { 
		name = magic_secret.1011.opt.d 
		scope:secret_owner = {
			add_opinion = {
				target = root
				modifier = kindness_opinion
				opinion = 30
			}
		}
		add_piety = -25
		ai_chance = {
			base = 5
			ai_value_modifier = {
				ai_compassion = 1.5
				ai_boldness = -1.5 
				ai_zeal = -3
			}
			modifier = { 
				scope:secret_owner = { 
					has_perk = light_magic_tree_3_perk_2
				}
				factor = 20
			}
			modifier = { 
				opinion = { 
					target = scope:secret_owner
					value < medium_negative_opinion
				}
				factor = 0.1
			}
		}
	}

	# ask to become dark apprentice
	# option = { 
	# 	name = magic_secret.1011.opt.e 
	# }
}

##################################################################
# 2001 - 9999 : Magic Secret Events
# (all lifestyles yearly pulse)
##################################################################


# Additional ideas:
# - Blackmailer coerces you to do illegal magic for them
# - You have an opportunity to do illegal magic on your blackmailer only you can remove
#   -- If the blackmailer doesnt know anyone else that can do that kind of magic, they will likely accept!
# - Blackmailer wants to learn this illegal magic from you
#   -- Dark Apprentice story cycle???????? could be fun!