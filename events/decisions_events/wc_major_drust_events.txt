namespace = drust_crisis

### DRUST INCURSION DECISION EVENTS ###
#Gorak Tul invades - triggered by Summon Gorak Tul decision
drust_crisis.1 = {
	type = character_event
	title = drust_crisis.1.t
	desc = drust_crisis.1.desc
	theme = realm
	right_portrait = {
		character = root
		animation = idle
	}

	immediate = {
		save_scope_as = summoner		
		set_global_variable = drust_incursion_happened		# Locks the crisis opening event if it didn't happen
	}
	
	right_portrait = {
		character = scope:summoner
		animation = spymaster
	}

	option = {
		name = drust_crisis.1.a
		custom_tooltip = drust_crisis.1.a.tt
		
		# Summon Gorak Tul
		create_character = {
			template = gorak_tul_character_template
			save_scope_as = gorak_tul
			location = root.location
		}

		declare_war_on_kt_gorak_tul_effect = yes
		trigger_event = drust_crisis.3
	}
}

# Sets up the court
drust_crisis.2 = {
	type = character_event
	title = drust_crisis.2.t
	desc = drust_crisis.2.desc
	theme = realm
	override_background = wc_throne_of_thunder

	immediate = {
		gorak_tul_create_court_effect = yes
		save_scope_as = gorak_tul
	}
	
	lower_left_portrait = {
		character = scope:ingra_maloch
	}
	lower_right_portrait = {
		character = scope:ingra_drif
	}
	lower_center_portrait = {
		character = scope:ingra_saor
	}

	left_portrait = {
		character = ROOT
		animation = war_over_win
	}

	right_portrait = {
		character = scope:summoner
		animation = personality_honorable
	}

	option = {
		name = drust_crisis.2.a
		custom_tooltip = drust_crisis.2.a.tt
	}
}

# Summoner swears fealty to Gorak Tul
drust_crisis.3 = { 
	type = character_event
	title = drust_crisis.3.t
	desc = drust_crisis.3.desc
	theme = realm
	override_background = wc_throne_of_thunder

	immediate = {
		save_scope_as = summoner
		scope:gorak_tul = {
			save_scope_as = gorak_tul
			set_variable = {
				name = summoner
				value = ROOT
			}
		}
	}

	left_portrait = {
		character = ROOT
		animation = celebrate_mace
	}

	right_portrait = {
		character = scope:gorak_tul
		animation = war_over_win
	}

	option = {
		name = drust_crisis.3.a
		scope:gorak_tul = {
			gorak_tul_effect = yes
		}
		set_player_character = scope:gorak_tul
		ai_chance = {
			base = 0
		}
	}

	option = {
		name = drust_crisis.3.b
		custom_tooltip = drust_crisis.3.warning.tt
		scope:gorak_tul = {
			gorak_tul_effect = yes
		}
	}
	after = {
		scope:gorak_tul = {	# Gorak Tul Setup
			create_story = story_drust_incursion
		}
	}
}

#drust_crisis.4 is unused

#Drust King, Gorak Tul contacts the grief-stricken spouse
drust_crisis.5 = {
	type = character_event
	title = drust_crisis.5.t
	desc = drust_crisis.5.desc
	theme = realm
	override_background = wc_throne_of_thunder

	# Not even death will do us part
	option = {
		name = drust_crisis.5.a
		
		scope:worried_spouse = {
			add_trait = being_undead
			set_character_faith = faith:throsic
		}
		scope:sick_spouse = {
			add_trait = being_undead
			set_character_faith = faith:throsic
		}
		
		scope:sick_spouse = { trigger_event = drust_crisis.6 }
		
		# Gives units to d_drustwar holder
		if = {
			limit = {
				title:d_drustwar.holder = {
					OR = {
						this = scope:worried_spouse
						this = scope:sick_spouse
					}
				}
			}
			title:d_drustwar.holder = {
				save_scope_as = unit_owner
			}
		}
		# ...otherwise, gives units to worried_spouse
		else_if = {
			limit = { scope:worried_spouse = { is_landed = yes } }
			scope:worried_spouse = {
				save_scope_as = unit_owner
			}
		}
		# ...otherwise, gives units to sick_spouse
		else_if = {
			limit = { scope:sick_spouse = { is_landed = yes } }
			scope:sick_spouse = {
				save_scope_as = unit_owner
			}
		}
		scope:unit_owner = {
			# Gives troops
			heartsbane_spawn_starting_troops_effect = yes
			heartsbane_spawn_starting_troops_effect = yes
		}
		
		# Independence stuff goes here
		if = {
			limit = {
				scope:worried_spouse = {
					is_independent_ruler = no
					liege = { NOT = { faith = faith:throsic } }
				} 
			}
			save_scope_as = drustvar_holder
			declare_war_on_kt_heartsbane_effect = yes
		}
		else_if = {
			limit = {
				scope:sick_spouse = {
					is_independent_ruler = no
					liege = { NOT = { faith = faith:throsic } }
				} 
			}
			save_scope_as = drustvar_holder
			declare_war_on_kt_heartsbane_effect = yes
		}
		
		# Notify the Admiral
		title:k_kul_tiras.holder = { trigger_event = drust_crisis.7 }


		ai_chance = {
			base = 1
		}
	}

	# I refuse
	option = {
		name = drust_crisis.5.b

		add_character_flag = heartsbane_coven_declined_flag

		custom_tooltip = {
			text = stops_the_event_chain
			remove_variable = heartsbane_coven_event_var
			remove_variable = drustvar_crisis_ongoing_var	# Blocks summon_gorak_tul
		}

		ai_chance = {
			base = 0
		}
	}
}

#Ping the raised spouse
drust_crisis.6 = {
	type = character_event
	title = drust_crisis.6.t
	desc = drust_crisis.6.desc
	theme = realm
	override_background = wc_throne_of_thunder

	option = {
		name = drust_crisis.6.a # Dynloc is to be used depending on spouse's gender here, if male bargainer, Gorak raises his spouse as Mother of the Heartsbane
	}
}

#Notify the Admiral
drust_crisis.7 = {
	type = character_event
	title = drust_crisis.7.t
	desc = drust_crisis.7.desc
	theme = realm
	override_background = wc_throne_of_thunder

	immediate = {
		remove_global_variable = drustvar_crisis_ongoing_var
	}

	option = {
		name = drust_crisis.7.a
	}
}

#Notify the Eastern Kingdoms
drust_crisis.8 = {
	type = character_event
	title = drust_crisis.8.t
	desc = drust_crisis.8.desc
	theme = realm
	override_background = wc_throne_of_thunder

	option = {
		name = drust_crisis.8.a
	}
}