namespace = drust_crisis

### DRUST INCURSION DECISION EVENTS ###
#Gorak Tul invades - triggered by Summon Gorak Tul decision
drust_crisis.1 = {
	type = character_event
	title = drust_crisis.1.t
	desc = drust_crisis.1.desc
	theme = realm
	right_portrait = {
		character = root
		animation = idle
	}

	immediate = {
		save_scope_as = summoner		
		set_global_variable = drust_incursion_happened		# Locks the crisis opening event if it didn't happen
	}
	
	right_portrait = {
		character = scope:summoner
		animation = spymaster
	}

	option = {
		name = drust_crisis.1.a
		custom_tooltip = drust_crisis.1.a.tt
		
		# Summon Gorak Tul
		create_character = {
			template = gorak_tul_character_template
			save_scope_as = gorak_tul
			location = root.location
		}
	
		trigger_event = drust_crisis.3
	}
}

# Sets up the court
drust_crisis.2 = {
	type = character_event
	title = drust_crisis.2.t
	desc = drust_crisis.2.desc
	theme = realm
	override_background = wc_throne_of_thunder

	immediate = {
		gorak_tul_create_court_effect = yes
		save_scope_as = gorak_tul
	}
	
	lower_left_portrait = {
		character = scope:ingra_maloch
	}
	lower_right_portrait = {
		character = scope:ingra_drif
	}
	lower_center_portrait = {
		character = scope:ingra_saor
	}

	left_portrait = {
		character = ROOT
		animation = war_over_win
	}

	right_portrait = {
		character = scope:summoner
		animation = personality_honorable
	}

	option = {
		name = drust_crisis.2.a
		custom_tooltip = drust_crisis.2.a.tt
	}
}

# Summoner swears fealty to Gorak Tul
drust_crisis.3 = { 
	type = character_event
	title = drust_crisis.3.t
	desc = drust_crisis.3.desc
	theme = realm
	override_background = wc_throne_of_thunder

	immediate = {
		save_scope_as = summoner
		scope:gorak_tul = {
			save_scope_as = gorak_tul
			set_variable = {
				name = summoner
				value = ROOT
			}
		}
	}

	left_portrait = {
		character = ROOT
		animation = celebrate_mace
	}

	right_portrait = {
		character = scope:gorak_tul
		animation = war_over_win
	}

	option = {
		name = drust_crisis.3.a
		scope:gorak_tul = {
			gorak_tul_effect = yes
		}
		set_player_character = scope:gorak_tul
		ai_chance = {
			base = 0
		}
	}

	option = {
		name = drust_crisis.3.b
		custom_tooltip = drust_crisis.3.warning.tt
		scope:gorak_tul = {
			gorak_tul_effect = yes
		}
	}
	after = {
		scope:gorak_tul = {	# Gorak Tul Setup
			create_story = story_drust_incursion
		}
	}
}

# Heartsbane Coven opening event: A sick spouse
drust_crisis.4 = {
	type = character_event
	title = drust_crisis.4.t
	desc = drust_crisis.4.desc
	theme = realm
	override_background = wc_throne_of_thunder

	trigger = {
		NOT = {	has_global_variable = drust_incursion_happened }
		NOT = {	has_global_variable = heartsbane_coven_event_var }
		
		has_landed_title = d_drustwar
		highest_held_title_tier < tier_kingdom
		
		trigger_if = {
			limit = { drust_sick_spouse_trigger = yes }
			any_spouse = { drust_worried_spouse_trigger = yes }
		}
		trigger_else = {
			drust_worried_spouse_trigger = yes
			any_spouse = { drust_sick_spouse_trigger = yes }
		}
	}

	immediate = {
		set_global_variable = heartsbane_coven_event_var
		set_global_variable = drustvar_crisis_ongoing_var	# Blocks summon_gorak_tul
		
		# Picks who is sick and who isn't
		if = {
			limit = { drust_sick_spouse_trigger = yes }
			save_scope_as = sick_spouse
			random_spouse = {
				limit = { drust_worried_spouse_trigger = yes }
				save_scope_as = worried_spouse
			}
		}
		else = {
			save_scope_as = worried_spouse
			random_spouse = {
				limit = { drust_sick_spouse_trigger = yes }
				save_scope_as = sick_spouse
			}
		}
		
		#scope:worried_spouse = { trigger_event = drust_crisis.5 }
	}
}

#Drust King, Gorak Tul contacts the grief-stricken spouse
drust_crisis.5 = {
	type = character_event
	title = drust_crisis.5.t
	desc = drust_crisis.5.desc
	theme = realm
	override_background = wc_throne_of_thunder

	# Not even death will do us part
	option = {
		name = drust_crisis.5.a
		
		scope:worried_spouse = {
			add_trait = being_undead
			faith = throsic
		}
		scope:sick_spouse = {
			add_trait = being_undead
			faith = throsic
		}
		
		scope:sick_spouse = { trigger_event = drust_crisis.6 }
		
		# Gives units to d_drustwar holder
		if = {
			limit = {
				d_drustwar = {
					holder_scope = {
						OR = {
							character = event_target:target_worried_spouse
							character = event_target:target_sick_spouse
						}
					}
				}
			}
			d_drustwar = {
				holder_scope = {
					save_event_target_as = target_unit_owner
				}
			}
		}
		# ...otherwise, gives units to target_worried_spouse
		else_if = {
			limit = { event_target:target_worried_spouse = { is_landed = yes } }
			event_target:target_worried_spouse = {
				save_event_target_as = target_unit_owner
			}
		}
		# ...otherwise, gives units to target_sick_spouse
		else = {
			limit = { event_target:target_sick_spouse = { is_landed = yes } }
			event_target:target_sick_spouse = {
				save_event_target_as = target_unit_owner
			}
		}
		if = {
			limit = { event_target:target_unit_owner = { character = yes } }
			event_target:target_unit_owner = {
				# Gives money, spawn commanders
				for_war_start_pack_effect = yes
				# Gives troops
				spawn_colonial_troops_effect = yes
				spawn_colonial_troops_effect = yes
			}
		}
		
		# Independence?
		if = {
			limit = {
				event_target:target_worried_spouse = {
					independent = no
					is_ruler = yes
					
					liege = { NOT = { religion = throsic } }
				} 
			}
			event_target:target_worried_spouse = { set_defacto_liege = THIS }
		}
		if = {
			limit = {
				event_target:target_sick_spouse = {
					independent = no
					is_ruler = yes
					
					liege = { NOT = { religion = throsic } }
				} 
			}
			event_target:target_sick_spouse = { set_defacto_liege = THIS }
		}

		# Independence war goes here
		73 = { province_event = { id = WCCRS.119 days = 7 } }

		ai_chance = {
			factor = 1
		}
	}

	# I refuse
	option = {
		name = drust_crisis.5.b

		set_character_flag = heartsbane_coven_declined_flag

		custom_tooltip = {
			text = stops_the_event_chain
			remove_variable = heartsbane_coven_event_var
			remove_variable = drustvar_crisis_ongoing_var	# Blocks summon_gorak_tul
		}

		ai_chance = {
			factor = 0
		}
	}
}

#Ping the raised spouse
drust_crisis.6 = {
	type = character_event
	title = drust_crisis.6.t
	desc = drust_crisis.6.desc
	theme = realm
	override_background = wc_throne_of_thunder

	option = {
		name = drust_crisis.6.a # Dynloc is to be used depending on spouse's gender here, if male bargainer, Gorak raises his spouse as Mother of the Heartsbane
	}
}