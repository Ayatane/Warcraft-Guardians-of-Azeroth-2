namespace = wc_scourge_plague

wc_scourge_plague.1000 = { #Scourge plague story cycle pacing control
	hidden = yes

	immediate = {
		if = {
			limit = {
				any_neighboring_top_liege_realm_owner = {
					has_character_flag = scourge_plague_splash
				}
			}
			if = {
				limit = {
					has_character_flag = scourge_plague_closer
				}
				remove_character_flag = scourge_plague_closer
			}
			add_character_flag = scourge_plague_nearby
		}
		else_if = {
			limit = {
				any_neighboring_top_liege_realm_owner = {
					any_neighboring_top_liege_realm_owner = {
						has_character_flag = scourge_plague_splash
					}
				}
			}	
			add_character_flag = scourge_plague_closer
		}
		if = {
			limit = {
				OR = {
					has_character_flag = scourge_plague_closer
					has_character_flag = scourge_plague_nearby
				}
				NOT = {
					has_character_flag = scourge_plague_info_event
				}
			}
			trigger_event = {
				id = wc_scourge_plague.1001
				days = { 2 4 }
			}
		}
	}
}

# The Scourge Plague is closing in
# Used to trigger Scourge Plague Story cycle
wc_scourge_plague.1001 = {
	type = character_event
	title = wc_scourge_plague.1001.t
	desc = wc_scourge_plague.1001.desc
	theme = plague
	override_background = { reference = study }
	left_portrait = {
		character = root
		animation = worry
	}

	trigger = {
		is_ai = no
		is_available_adult = yes
		is_travelling = no
		NOR = {
			any_sub_realm_county = { #Undead Plague is already here, no need to talk about it closing in
				any_county_province = {
					any_province_epidemic = {
						this = global_var:undead_scourge
					}
				}
			}
		}
	}

	on_trigger_fail = {
		trigger_event = {
			id = wc_scourge_plague.1001
			days = { 7 14 }
		}
	}

	immediate = {
		play_music_cue = mx_cue_death
		add_character_flag = scourge_plague_info_event
		if = {
			limit = {
				NOR = {
					has_character_flag = scourge_plague_closer
					has_character_flag = scourge_plague_nearby
				}
			}
			add_character_flag = scourge_plague_closer
		}
		
		hidden_effect = {
			every_sub_realm_county = {
				limit = {
					any_county_province = {
						any_province_epidemic = {
							this = scope:epidemic_scope
						}
					}
				}
			}
		}
	}

	option = { # Ha, let them die!
		name = wc_scourge_plague.1001.a

		trigger = {
			has_trait = callous
		}

		flavor = wc_scourge_plague.1001.a.tt

		stress_impact = {
			base = medium_stress_impact_loss
		}

		ai_chance = {
			base = 50
			ai_value_modifier = {
				ai_compassion = -1
			}
		}
	}

	option = { # The end times are upon us!
		name = wc_scourge_plague.1001.b

		trigger = {
			has_trait = paranoid
		}

		flavor = wc_scourge_plague.1001.b.tt

		add_character_modifier = {
			modifier = plague_tales
			years = 15
		}

		stress_impact = {
			base = minor_stress_impact_gain
		}

		ai_chance = {
			base = 50
			ai_value_modifier = {
				ai_rationality = 0.5
				ai_greed = -1
			}
		}
	}

	option = { # Oh no
		name =  wc_scourge_plague.1001.c

		stress_impact = {
			base = miniscule_stress_impact_gain
			craven = minor_stress_impact_gain
			paranoid = minor_stress_impact_gain
		}

		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_energy = -0.5
			}
		}
	}
}

wc_scourge_plague.1002 = {
	type = character_event
	window = fullscreen_event
	title = wc_scourge_plague.1002.t
	desc = wc_scourge_plague.1002.desc
	theme = plague
	override_background = { reference = ce1_fullscreen_black_death }
	cooldown = { years = 5 }

	immediate = {
		add_character_flag = scourge_plague_splash
		#play_music_cue = black_death
		add_plague_county_modifiers = yes
		if = {
			limit = {
				any_owned_story = {
					story_type = story_cycle_scourge_plague
				}
			}
			random_owned_story = {
				limit = {
					story_type = story_cycle_scourge_plague
				}
				end_story = yes
			}
		}
		
		if = {
			limit = {
				NOT = { is_target_in_global_variable_list = { name = unavailable_unique_events target = flag:arthas_expedition } }
				frostmourne_can_be_found_trigger = yes
				game_start_date <= 603.1.1

				is_independent_ruler = yes
				is_vulnerable_to_plague_character_trigger = yes
				capital_province = { geographical_region = world_eastern_kingdoms_lordaeron }
			}
			add_to_global_variable_list = {
				name = unavailable_unique_events
				target = flag:arthas_expedition
			}
			add_to_global_variable_list = {
				name = unavailable_unique_events
				target = flag:frostmourne_ongoing
			}

			save_scope_value_as = { name = arthas_exists value = yes }
			find_arthas_effect = yes
			primary_title = { save_scope_as = lordaeron }
			
			if = {
				limit = {
					exists = scope:arthas_exists
					exists = global_var:terenas_character
				}
				global_var:terenas_character = { trigger_event = wc_scourge_plague.1003 }
			}
		}
	}

	option = {
		name = wc_scourge_plague.1002.a
		add_stress = medium_stress_gain
	}

	after = {
		trigger_event = {
			id = health.3001 days = { court_physician_search_min court_physician_search_max }
		}
	}
}

wc_scourge_plague.1003 = {
	hidden = yes

	immediate = {
		find_hearthglen_effect = yes
		scope:hearthglen = { set_global_variable = { name = hearthglen value = this } }
		find_stratholme_effect = yes
		scope:stratholme = { set_global_variable = { name = stratholme value = this } }
		add_to_global_variable_list = {
			name = unavailable_unique_events
			target = flag:arthas_activity_good_to_go
		}

		global_var:arthas_character = {
			if = { limit = { is_ai = yes } add_character_flag = { flag = wc_cannot_serve_in_army years = 1 } }
			else = { add_character_flag = { flag = wc_cannot_serve_in_army weeks = 10 } }
			trigger_event = wc_arthas_story.9
		}
	}
}

# SCOURGE PLAGUE EVENTS - OOOOH SPOOKY
# 1004-///
#		 	______
#        .-"      "-.
#       /            \
#      |              |
#      |,  .-.  .-.  ,|
#      | )(__/  \__)( |
#      |/     /\     \|
#      (_     ^^     _)
#       \__|IIIIII|__/
#        | \IIIIII/ |
#        \          /⠀⠀

scripted_effect wc_scourge_plague_1004_add_courtier_effect = {
	save_scope_as = new_courtier
	hidden_effect = { root = { add_courtier = scope:new_courtier } }
	custom_tooltip = wc_scourge_plague_1004_add_courtier_effect.tt
	add_opinion = {
		target = root
		modifier = grateful_opinion
		opinion = $OPINION$
	}
}

### You are a living person ###
# Priests of Quel'thalas show up at your court
# by ElMariuso
wc_scourge_plague.1004 = {
	type = character_event
	title = wc_scourge_plague.1004.t
	desc = wc_scourge_plague.1004.desc
	theme = plague
	override_background = { reference = throne_room }
	left_portrait = {
		character = root
		animation = throne_room_conversation_1
	}
	right_portrait = {
		character = scope:first_priest_of_quel_thalas
		animation = throne_room_bow_1
	}
	lower_right_portrait = {
		character = scope:second_priest_of_quel_thalas
	}
	cooldown = { years = 10 }
	
	trigger = {
		is_available_healthy_adult = yes
		NOT = {
			has_trait = incapable
			has_trait = being_undead # You should be alive
		}
		is_travelling = no
		
		# Quel'thalas exist ?
		OR = {
			title:e_quelthalas = {
				is_neighbor_to_realm = root.top_liege
				holder = {
					any_realm_county = {
						faith.religion = religion:light_group
						culture = { has_same_culture_heritage = culture:high_elf }
					}
				}
			}
			
			title:k_quelthalas = {
				is_neighbor_to_realm = root.top_liege
				holder = {
					any_realm_county = {
						faith.religion = religion:light_group
						culture = { has_same_culture_heritage = culture:high_elf }
					}
				}
			}
		}
	}
	
	immediate = {
		if = {
			limit = { exists = title:e_quelthalas.holder }
			title:e_quelthalas = { save_scope_as = quelthalas }
		}
		else_if = {
			limit = { exists = title:k_quelthalas.holder }
			title:k_quelthalas = { save_scope_as = quelthalas }
		}
		
		if = {
			limit = {
				OR = {
					exists = title:e_quelthalas.holder
					exists = title:k_quelthalas.holder
				}
			}
		
			scope:quelthalas.holder = {
				random_realm_county = {
					limit = {
						faith.religion = religion:light_group
						culture = { has_same_culture_heritage = culture:high_elf }
					}
					faith = { save_scope_as = priest_quelthalas_faith }
					culture = { save_scope_as = priest_quelthalas_culture }
				}
			}
			
			create_character = {
				template = priest_of_quel_thalas_character_template
				location = root.location
				save_scope_as = first_priest_of_quel_thalas
			}
			create_character = {
				template = priest_of_quel_thalas_character_template
				location = root.location
				save_scope_as = second_priest_of_quel_thalas
			}
		}
	}
	
	option = { # Accept
		name = wc_scourge_plague.1004.a

		# You have a debt on them for the help
		scope:first_priest_of_quel_thalas = {
			if = {
				limit = {
					can_add_hook = {
						target = root
						type = favor_hook
					}
				}
				add_hook = {
					target = root
					type = favor_hook
				}
			}
			wc_scourge_plague_1004_add_courtier_effect = { OPINION = 20 }
		}
		scope:second_priest_of_quel_thalas = {
			if = {
				limit = {
					can_add_hook = {
						target = root
						type = favor_hook
					}
				}
				add_hook = {
					target = root
					type = favor_hook
				}
			}
			wc_scourge_plague_1004_add_courtier_effect = { OPINION = 20 }
		}
		
		add_character_modifier = {
			modifier = wc_priests_of_quelthalas_fighting
			years = 5
		}
		
		stress_impact = {
			base = miniscule_stress_impact_loss
			paranoid = major_stress_impact_gain
			callous = medium_stress_impact_gain
			sadistic = major_stress_impact_gain
			compassionate = medium_stress_impact_loss
		}
		
		hidden_effect = {
			if = {
				limit = { can_set_relation_potential_friend_trigger = { CHARACTER = scope:first_priest_of_quel_thalas } }
				set_relation_potential_friend = scope:first_priest_of_quel_thalas
			}
			if = {
				limit = { can_set_relation_potential_friend_trigger = { CHARACTER = scope:second_priest_of_quel_thalas } }
				set_relation_potential_friend = scope:second_priest_of_quel_thalas
			}
		}
		
		ai_chance = {
			base = 50
		}
	}
	
	option = { # Refuse
		name = wc_scourge_plague.1004.b
		
		stress_impact = {
			base = miniscule_stress_impact_loss
			paranoid = minor_stress_impact_loss
			callous = minor_stress_impact_loss
			sadistic = medium_stress_impact_loss
			compassionate = medium_stress_impact_gain
			generous = medium_stress_impact_gain
			gregarious = minor_stress_impact_gain
		}
		
		ai_chance = {
			base = 50
		}
	}
	
	option = { # Moderate
		name = wc_scourge_plague.1004.c
		
		# You have a debt on him for the help
		scope:first_priest_of_quel_thalas = {
			if = {
				limit = {
					can_add_hook = {
						target = root
						type = favor_hook
					}
				}
				add_hook = {
					target = root
					type = favor_hook
				}
			}
			wc_scourge_plague_1004_add_courtier_effect = { OPINION = 5 }
		}
		
		add_character_modifier = {
			modifier = wc_priests_of_quelthalas_fighting
			years = 1
		}
		
		stress_impact = {
			base = miniscule_stress_impact_loss
			paranoid = medium_stress_impact_gain
			callous = minor_stress_impact_gain
			sadistic = medium_stress_impact_gain
			compassionate = minor_stress_impact_loss
		}
		
		ai_chance = {
			base = 50
		}
	}
}